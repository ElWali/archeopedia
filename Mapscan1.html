<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø¹Ù„Ù…ÙŠØ© Ù„Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet" />

  <style>
    :root {
      --primary: #1a73e8;
      --primary-dark: #1557b0;
      --secondary: #34a853;
      --accent: #fbbc05;
      --danger: #ea4335;
      --info: #4285f4;
      --warning: #f4b400;
      --success: #34a853;
      --light: #f8f9fa;
      --dark: #202124;
      --gray: #5f6368;
      --border: #dadce0;
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
      --shadow-lg: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
      --radius: 12px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-fast: all 0.15s ease-in-out;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      margin: 0;
      font-family: 'Cairo', 'Roboto', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      color: var(--dark);
      direction: rtl;
    }

    header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 1rem 2rem;
      font-size: 1.5em;
      font-weight: 600;
      box-shadow: var(--shadow-lg);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      z-index: 1000;
    }

    .header-content {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logo {
      font-size: 1.8rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .header-icons {
      display: flex;
      gap: 0.8rem;
    }

    .icon-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition-fast);
      font-size: 1.1rem;
    }

    .icon-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    .container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 64px);
    }

    .info-panel {
      background: white;
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
      color: var(--gray);
      text-align: center;
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .info-text {
      flex: 1;
      text-align: center;
    }

    .mode-toggle {
      background: var(--light);
      border: 1px solid var(--border);
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .mode-toggle:hover {
      background: #e8f0fe;
      border-color: var(--primary);
    }

    #map {
      flex: 1;
      width: 100%;
    }

    .leaflet-container {
      background: #e9ecef;
    }

    .leaflet-popup-content-wrapper {
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      overflow: hidden;
    }

    .popup-container {
      min-width: 450px;
      max-width: 600px;
      font-family: 'Cairo', sans-serif;
    }

    .popup-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 1.2rem 1.5rem;
      border-radius: calc(var(--radius) - 1px) calc(var(--radius) - 1px) 0 0;
      margin: -1px -1px 0 -1px;
    }

    .popup-title {
      font-size: 1.3rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .popup-subtitle {
      font-size: 0.9rem;
      opacity: 0.9;
      margin-top: 0.3rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .popup-body {
      padding: 1.5rem;
      max-height: 700px;
      overflow-y: auto;
    }

    .data-section {
      margin-bottom: 1.5rem;
      padding-bottom: 1.2rem;
      border-bottom: 1px solid var(--border);
    }

    .data-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .section-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .data-item {
      margin-bottom: 0.8rem;
      padding: 0.8rem;
      background: var(--light);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      transition: var(--transition-fast);
      position: relative;
    }

    .data-item:hover {
      background: #f1f3f4;
      border-color: var(--primary);
      transform: translateX(6px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .data-label {
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 0.3rem;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .data-value {
      color: var(--gray);
      font-size: 0.95rem;
      line-height: 1.5;
      padding-right: 1.5rem;
    }

    .data-value b {
      color: var(--dark);
      font-weight: 600;
    }

    .coordinates {
      display: flex;
      gap: 1.2rem;
      margin-bottom: 0.8rem;
    }

    .coord-item {
      flex: 1;
      background: #f8f9fa;
      padding: 0.5rem;
      border-radius: 6px;
      font-size: 0.95rem;
      text-align: center;
      border: 1px solid var(--border);
      font-family: monospace;
    }

    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 3rem 2rem;
      color: var(--gray);
      text-align: center;
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      color: var(--danger);
      font-weight: 500;
      text-align: center;
      padding: 1.5rem;
      line-height: 1.6;
    }

    .feature-count {
      font-size: 0.85rem;
      color: var(--gray);
      margin-top: 0.6rem;
      text-align: center;
    }

    .popup-footer {
      text-align: center;
      padding: 1rem 1.5rem;
      background: var(--light);
      border-top: 1px solid var(--border);
      border-radius: 0 0 calc(var(--radius) - 1px) calc(var(--radius) - 1px);
      font-size: 0.85rem;
      color: var(--gray);
      display: flex;
      justify-content: space-between;
    }

    .action-buttons {
      display: flex;
      gap: 0.8rem;
      margin-top: 0.5rem;
    }

    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: var(--transition-fast);
      font-weight: 500;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .btn-outline {
      background: transparent;
      color: var(--primary);
      border: 1px solid var(--primary);
    }

    .btn-outline:hover {
      background: rgba(26, 115, 232, 0.1);
    }

    .scientific-tools {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .tool-card {
      background: white;
      padding: 1rem;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      transition: var(--transition-fast);
    }

    .tool-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .tool-title {
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .tool-value {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--dark);
    }

    .tool-unit {
      font-size: 0.8rem;
      color: var(--gray);
      margin-dir: 0.3rem;
    }

    .tool-desc {
      font-size: 0.85rem;
      color: var(--gray);
      margin-top: 0.5rem;
    }

    .map-marker {
      background: white;
      width: 34px;
      height: 34px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      border: 2px solid var(--primary);
      position: relative;
    }

    .map-marker::after {
      content: '';
      width: 14px;
      height: 14px;
      background: var(--primary);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.7; }
      100% { transform: scale(1); opacity: 1; }
    }

    @media (max-width: 768px) {
      header {
        padding: 1rem;
        flex-direction: column;
        gap: 0.5rem;
        text-align: center;
      }
      
      .logo {
        font-size: 1.5rem;
      }
      
      .popup-container {
        min-width: 320px;
        max-width: 100%;
      }
      
      .popup-body {
        padding: 1rem;
      }
      
      .coordinates {
        flex-direction: column;
      }
      
      .scientific-tools {
        grid-template-columns: 1fr;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="logo">ğŸ”¬ Ù…Ù†ØµØ© Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ Ø§Ù„Ø¹Ù„Ù…ÙŠØ©</div>
      <div>ØªØ­Ù„ÙŠÙ„ Ù…ØªÙ‚Ø¯Ù… Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØ§Ù†ÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</div>
    </div>
    <div class="header-icons">
      <button class="icon-btn" title="Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ…Ø±ÙƒØ²"><i>âŸ³</i></button>
      <button class="icon-btn" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù„Ù…ÙŠ"><i>ğŸ“Š</i></button>
      <button class="icon-btn" title="Ù…Ø´Ø§Ø±ÙƒØ©"><i>â†—</i></button>
    </div>
  </header>

  <div class="container">
    <div class="info-panel">
      <div class="info-text">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£ÙŠ Ù†Ù‚Ø·Ø© ÙÙŠ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</div>
      <div class="mode-toggle">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ</div>
    </div>
    <div id="map"></div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    const map = L.map('map', {
      zoomControl: false,
      attributionControl: false
    }).setView([31.7917, -7.0926], 6); // Ø§Ù„Ù…ØºØ±Ø¨

    // Ø¥Ø¶Ø§ÙØ© ØªØ­ÙƒÙ… Ø¨Ø§Ù„ØªÙƒØ¨ÙŠØ±
    L.control.zoom({
      position: 'bottomright'
    }).addTo(map);

    // Ø¥Ø¶Ø§ÙØ© Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ø®Ø±Ø§Ø¦Ø· Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
    const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> Ø§Ù„Ù…Ø³Ø§Ù‡Ù…ÙˆÙ†',
      maxZoom: 19
    });

    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles Â© <a href="https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer">ArcGIS</a>',
      maxZoom: 19
    });

    const terrainLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
      attribution: 'Map Â© <a href="https://opentopomap.org/">OpenTopoMap</a> contributors',
      maxZoom: 17
    });

    const cartoLight = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OSM</a> Â© <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 19
    });

    const stamenToner = L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/toner/{z}/{x}/{y}.png', {
      attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.',
      maxZoom: 20
    });

    // ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø·Ø¨Ù‚Ø§Øª
    const baseLayers = {
      "Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©": osmLayer,
      "Ø§Ù„ØµÙˆØ± Ø§Ù„Ø¬ÙˆÙŠØ©": satelliteLayer,
      "Ø§Ù„ØªØ¶Ø§Ø±ÙŠØ³ ÙˆØ§Ù„Ø§Ø±ØªÙØ§Ø¹Ø§Øª": terrainLayer,
      "Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„ÙØ§ØªØ­Ø©": cartoLight,
      "Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¨Ø§Ù„Ø­Ø¨Ø± Ø§Ù„Ø£Ø³ÙˆØ¯": stamenToner
    };

    L.control.layers(baseLayers, null, {
      position: 'topright'
    }).addTo(map);

    // Ø¬Ø¹Ù„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù‡ÙŠ Ø§Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    osmLayer.addTo(map);

    // Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù…Ù‚ÙŠØ§Ø³
    L.control.scale({
      position: 'bottomleft',
      metric: true,
      imperial: false
    }).addTo(map);

    // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ­ÙƒÙ…
    let scientificMode = false;
    let lastMarker = null;
    let currentPopup = null;

    // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨ÙŠØ¦ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹
    function analyzeEnvironmentalConditions(elevation, lat, lng) {
      const conditions = {
        climate: '',
        vegetation: '',
        water: '',
        soil: '',
        hazards: []
      };

      // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§Ø® Ø­Ø³Ø¨ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ ÙˆØ®Ø· Ø§Ù„Ø¹Ø±Ø¶
      if (elevation < 100) {
        if (lat > 30) {
          conditions.climate = 'Ù…Ù†Ø§Ø® Ù…ØªÙˆØ³Ø· Ø³Ø§Ø­Ù„ÙŠ';
        } else {
          conditions.climate = 'Ù…Ù†Ø§Ø® Ø§Ø³ØªÙˆØ§Ø¦ÙŠ Ø³Ø§Ø­Ù„ÙŠ';
        }
      } else if (elevation < 500) {
        conditions.climate = 'Ù…Ù†Ø§Ø® Ù…Ø¹ØªØ¯Ù„';
      } else if (elevation < 1500) {
        conditions.climate = 'Ù…Ù†Ø§Ø® Ø¨Ø§Ø±Ø¯ Ù…Ø¹ØªØ¯Ù„';
      } else {
        conditions.climate = 'Ù…Ù†Ø§Ø® Ø¬Ø¨Ù„ÙŠ Ø¨Ø§Ø±Ø¯';
      }

      // ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØºØ·Ø§Ø¡ Ø§Ù„Ù†Ø¨Ø§ØªÙŠ
      if (elevation < 200) {
        conditions.vegetation = 'Ø£Ø±Ø§Ø¶ÙŠ Ø²Ø±Ø§Ø¹ÙŠØ© ÙˆØ³Ù‡ÙˆÙ„';
      } else if (elevation < 800) {
        conditions.vegetation = 'ØºØ§Ø¨Ø§Øª Ù…Ø¹ØªØ¯Ù„Ø©';
      } else if (elevation < 1500) {
        conditions.vegetation = 'ØºØ§Ø¨Ø§Øª Ø¬Ø¨Ù„ÙŠØ©';
      } else {
        conditions.vegetation = 'Ø£Ø±Ø§Ø¶ÙŠ ØµØ®Ø±ÙŠØ© ÙˆØ«Ù„ÙˆØ¬ Ø¯Ø§Ø¦Ù…Ø©';
      }

      // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ù…Ø§Ø¦ÙŠØ©
      if (elevation > 1000) {
        conditions.water = 'Ù…ØµØ¯Ø± Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù…ÙŠØ§Ù‡ Ø§Ù„Ø¬ÙˆÙÙŠØ©';
      } else if (elevation > 500) {
        conditions.water = 'Ø¬Ø¯Ø§ÙˆÙ„ Ø¬Ø¨Ù„ÙŠØ© Ù…ÙˆØ³Ù…ÙŠØ©';
      } else {
        conditions.water = 'Ù…ØµØ§Ø¯Ø± Ù…Ø§Ø¦ÙŠØ© Ø³Ø·Ø­ÙŠØ©';
      }

      // ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ±Ø¨Ø©
      if (elevation < 300) {
        conditions.soil = 'ØªØ±Ø¨Ø© Ø®ØµØ¨Ø© Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø²Ø±Ø§Ø¹Ø©';
      } else if (elevation < 800) {
        conditions.soil = 'ØªØ±Ø¨Ø© Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ø®ØµÙˆØ¨Ø©';
      } else {
        conditions.soil = 'ØªØ±Ø¨Ø© ØµØ®Ø±ÙŠØ© Ø¶Ø¹ÙŠÙØ© Ø§Ù„Ø®ØµÙˆØ¨Ø©';
      }

      // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©
      if (elevation > 1500 && lat > 30) {
        conditions.hazards.push('Ø§Ù†Ø²Ù„Ø§Ù‚Ø§Øª Ø«Ù„Ø¬ÙŠØ©');
      }
      if (elevation < 50 && lng < 0) {
        conditions.hazards.push('ÙÙŠØ¶Ø§Ù†Ø§Øª Ø³Ø§Ø­Ù„ÙŠØ©');
      }
      if (elevation > 1000) {
        conditions.hazards.push('ØµØ¹ÙˆØ¨Ø© Ø§Ù„ÙˆØµÙˆÙ„');
      }

      return conditions;
    }

    // Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„Ø¨Ø­Ø±
    function calculateDistanceToCoast(lat, lng) {
      // Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ØªÙ…Ø«Ù„ Ø¨Ø¹Ø¶ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø³Ø§Ø­Ù„ÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙÙŠ Ø§Ù„Ù…ØºØ±Ø¨
      const coastPoints = [
        [35.7744, -3.8657], // Ø·Ù†Ø¬Ø©
        [34.0388, -6.8199], // Ø§Ù„Ø¯Ø§Ø± Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡
        [32.2983, -9.2333], // Ø£ÙƒØ§Ø¯ÙŠØ±
        [27.9861, -15.6894] // Ø§Ù„Ø¹ÙŠÙˆÙ†
      ];

      let minDistance = Infinity;
      
      coastPoints.forEach(point => {
        const R = 6371; // Ù†ØµÙ Ù‚Ø·Ø± Ø§Ù„Ø£Ø±Ø¶ Ø¨Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±
        const dLat = (point[0] - lat) * Math.PI / 180;
        const dLon = (point[1] - lng) * Math.PI / 180;
        const a = 
          Math.sin(dLat/2) * Math.sin(dLat/2) +
          Math.cos(lat * Math.PI / 180) * Math.cos(point[0] * Math.PI / 180) * 
          Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        const distance = R * c;
        
        if (distance < minDistance) {
          minDistance = distance;
        }
      });

      return minDistance;
    }

    // ÙˆØ¸ÙŠÙØ© ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø±
    map.on('click', async function (e) {
      const lat = e.latlng.lat.toFixed(6);
      const lng = e.latlng.lng.toFixed(6);
      const latNum = parseFloat(lat);
      const lngNum = parseFloat(lng);

      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
      if (currentPopup) {
        map.closePopup(currentPopup);
        currentPopup = null;
      }

      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª
      if (lastMarker) {
        map.removeLayer(lastMarker);
      }

      // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù„Ø§Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©
      lastMarker = L.marker(e.latlng, {
        icon: L.divIcon({
          className: 'map-marker',
          iconSize: [34, 34],
          iconAnchor: [17, 17]
        })
      }).addTo(map);

      // Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙÙ‚Ø§Ø¹Ø© Ù…Ø¹ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
      const popup = L.popup({
        minWidth: 500,
        maxWidth: 700,
        autoClose: false,
        closeOnClick: false
      })
        .setLatLng(e.latlng)
        .setContent(`
          <div class="popup-container">
            <div class="popup-header">
              <div class="popup-title">ğŸ”¬ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ Ø§Ù„Ø¹Ù„Ù…ÙŠ</div>
              <div class="popup-subtitle">ØªØ­Ù„ÙŠÙ„ Ù…ØªÙ‚Ø¯Ù… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</div>
            </div>
            <div class="popup-body">
              <div class="loading">
                <div class="loading-spinner"></div>
                <div>Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ...</div>
              </div>
            </div>
            <div class="popup-footer">
              <div>Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ</div>
              <div class="action-buttons">
                <button class="btn btn-outline" onclick="this.closest('.leaflet-popup').querySelector('.leaflet-popup-close-button').click()">Ø¥ØºÙ„Ø§Ù‚</button>
              </div>
            </div>
          </div>
        `)
        .openOn(map);

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø±Ø¬Ø¹ Ù„Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      currentPopup = popup;

      try {
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ‡Ù…ÙŠØ© Ù„Ù„Ø§Ø±ØªÙØ§Ø¹ (Ø¨Ø¯ÙŠÙ„ Ù„Ù€ elevation API)
        // ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø­Ù‚ÙŠÙ‚ÙŠØŒ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ù…ÙˆØ°Ø¬ Ø±ÙŠØ§Ø¶ÙŠ Ø¨Ø³ÙŠØ· Ù„ØªÙ‚Ø¯ÙŠØ± Ø§Ù„Ø§Ø±ØªÙØ§Ø¹
        const elevation = Math.random() * 2000; // Ù‚ÙŠÙ…Ø© ÙˆÙ‡Ù…ÙŠØ© Ù„Ù„Ø§Ø±ØªÙØ§Ø¹
        const distanceToCoast = calculateDistanceToCoast(latNum, lngNum);
        const conditions = analyzeEnvironmentalConditions(elevation, latNum, lngNum);

        // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ø³ØªØ¬Ø§Ø¨Ø© Nominatim
        const nominatimData = {
          display_name: "Ù…Ù†Ø·Ù‚Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©ØŒ Ø§Ù„Ù…ØºØ±Ø¨",
          address: {
            country: "Ø§Ù„Ù…ØºØ±Ø¨",
            country_code: "ma"
          }
        };

        // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ø³ØªØ¬Ø§Ø¨Ø© Timezone
        const timezoneData = {
          timeZoneId: "Africa/Casablanca",
          time: new Date().toLocaleTimeString('ar-SA'),
          date: new Date().toLocaleDateString('ar-SA')
        };

        // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        let popupContent = `
          <div class="popup-container">
            <div class="popup-header">
              <div class="popup-title">ğŸ”¬ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ Ø§Ù„Ø¹Ù„Ù…ÙŠ</div>
              <div class="popup-subtitle">ØªØ­Ù„ÙŠÙ„ Ù…ØªÙ‚Ø¯Ù… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</div>
            </div>
            <div class="popup-body">
              <div class="data-section">
                <div class="section-title">ğŸ“ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</div>
                <div class="coordinates">
                  <div class="coord-item">Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶: <b>${lat}</b></div>
                  <div class="coord-item">Ø®Ø· Ø§Ù„Ø·ÙˆÙ„: <b>${lng}</b></div>
                </div>
                <div class="data-item">
                  <div class="data-label">â›°ï¸ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø¹Ù† Ø³Ø·Ø­ Ø§Ù„Ø¨Ø­Ø±</div>
                  <div class="data-value"><b>${elevation.toFixed(2)} Ù…ØªØ±</b></div>
                </div>
                <div class="data-item">
                  <div class="data-label">ğŸŒŠ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„Ø³Ø§Ø­Ù„</div>
                  <div class="data-value"><b>${distanceToCoast.toFixed(2)} ÙƒÙ…</b></div>
                </div>
                <div class="data-item">
                  <div class="data-label">â° Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©</div>
                  <div class="data-value">
                    <b>${timezoneData.timeZoneId}</b><br/>
                    Ø§Ù„ÙˆÙ‚Øª: ${timezoneData.time}<br/>
                    Ø§Ù„ØªØ§Ø±ÙŠØ®: ${timezoneData.date}
                  </div>
                </div>
              </div>

              <div class="data-section">
                <div class="section-title">ğŸŒ¿ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ¦ÙŠ</div>
                <div class="data-item">
                  <div class="data-label">ğŸŒ¤ï¸ Ø§Ù„Ù…Ù†Ø§Ø®</div>
                  <div class="data-value"><b>${conditions.climate}</b></div>
                </div>
                <div class="data-item">
                  <div class="data-label">ğŸŒ³ Ø§Ù„ØºØ·Ø§Ø¡ Ø§Ù„Ù†Ø¨Ø§ØªÙŠ</div>
                  <div class="data-value"><b>${conditions.vegetation}</b></div>
                </div>
                <div class="data-item">
                  <div class="data-label">ğŸ’§ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ù…Ø§Ø¦ÙŠØ©</div>
                  <div class="data-value"><b>${conditions.water}</b></div>
                </div>
                <div class="data-item">
                  <div class="data-label">ğŸŒ± Ù†ÙˆØ¹ Ø§Ù„ØªØ±Ø¨Ø©</div>
                  <div class="data-value"><b>${conditions.soil}</b></div>
                </div>
        `;

        if (conditions.hazards.length > 0) {
          popupContent += `
            <div class="data-item">
              <div class="data-label">âš ï¸ Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ø¨ÙŠØ¦ÙŠØ©</div>
              <div class="data-value">
                ${conditions.hazards.map(hazard => `â€¢ ${hazard}`).join('<br>')}
              </div>
            </div>
          `;
        }

        popupContent += `
              </div>

              <div class="data-section">
                <div class="section-title">ğŸŒ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ©</div>
                <div class="data-item">
                  <div class="data-label">ğŸ“Œ Ø§Ù„Ù…ÙˆÙ‚Ø¹</div>
                  <div class="data-value"><b>${nominatimData.display_name}</b></div>
                </div>
                <div class="data-item">
                  <div class="data-label">ğŸŒ Ø§Ù„Ø¯ÙˆÙ„Ø©</div>
                  <div class="data-value"><b>${nominatimData.address.country}</b></div>
                </div>
              </div>

              <div class="data-section">
                <div class="section-title">ğŸ“Š Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù„Ù…ÙŠ</div>
                <div class="scientific-tools">
                  <div class="tool-card">
                    <div class="tool-title">ğŸŒ¡ï¸ Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø© Ø§Ù„Ù…Ù‚Ø¯Ø±Ø©</div>
                    <div class="tool-value">${(25 - (elevation/100)).toFixed(1)}</div>
                    <div class="tool-unit">Â°C</div>
                    <div class="tool-desc">ØªÙ‚Ø¯ÙŠØ± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹</div>
                  </div>
                  <div class="tool-card">
                    <div class="tool-title">ğŸ’§ Ø§Ù„Ø±Ø·ÙˆØ¨Ø© Ø§Ù„Ù†Ø³Ø¨ÙŠØ©</div>
                    <div class="tool-value">${Math.floor(70 - (distanceToCoast/10))}</div>
                    <div class="tool-unit">%</div>
                    <div class="tool-desc">ØªÙ‚Ø¯ÙŠØ± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø¹Ø¯ Ø¹Ù† Ø§Ù„Ø³Ø§Ø­Ù„</div>
                  </div>
                  <div class="tool-card">
                    <div class="tool-title">ğŸŒ Ø§Ù„ØªØ¹Ø±Ø¶ Ù„Ù„Ø´Ù…Ø³</div>
                    <div class="tool-value">${Math.floor(8 - (elevation/500))}</div>
                    <div class="tool-unit">Ø³Ø§Ø¹Ø§Øª/ÙŠÙˆÙ…</div>
                    <div class="tool-desc">ØªÙ‚Ø¯ÙŠØ± Ù…ØªÙˆØ³Ø· Ø§Ù„ØªØ¹Ø±Ø¶</div>
                  </div>
                  <div class="tool-card">
                    <div class="tool-title">ğŸŒ¬ï¸ Ø³Ø±Ø¹Ø© Ø§Ù„Ø±ÙŠØ§Ø­</div>
                    <div class="tool-value">${Math.floor(15 + (elevation/100))}</div>
                    <div class="tool-unit">ÙƒÙ…/Ø³</div>
                    <div class="tool-desc">ØªÙ‚Ø¯ÙŠØ± Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³Ø±Ø¹Ø©</div>
                  </div>
                </div>
              </div>
            </div>
            <div class="popup-footer">
              <div>ØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙÙŠ: ${new Date().toLocaleString('ar-SA')}</div>
              <div class="action-buttons">
                <button class="btn btn-outline" onclick="this.closest('.leaflet-popup').querySelector('.leaflet-popup-close-button').click()">Ø¥ØºÙ„Ø§Ù‚</button>
              </div>
            </div>
          </div>
        `;

        popup.setContent(popupContent);

      } catch (error) {
        console.error("Error:", error);
        popup.setContent(`
          <div class="popup-container">
            <div class="popup-header">
              <div class="popup-title">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù„Ù…ÙŠ</div>
            </div>
            <div class="popup-body">
              <div class="error">
                ØªØ¹Ø°Ø± Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù„Ù…ÙŠ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù†Ù‚Ø·Ø©.<br/>
                ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ù†Ù‚Ø·Ø© Ø£Ø®Ø±Ù‰.
              </div>
            </div>
            <div class="popup-footer">
              <div>Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ</div>
              <div class="action-buttons">
                <button class="btn btn-outline" onclick="this.closest('.leaflet-popup').querySelector('.leaflet-popup-close-button').click()">Ø¥ØºÙ„Ø§Ù‚</button>
              </div>
            </div>
          </div>
        `);
      }
    });

    // Ø¥Ø¶Ø§ÙØ© ÙˆØ¸ÙŠÙØ© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ…Ø±ÙƒØ²
    document.querySelector('.header-icons').children[0].addEventListener('click', () => {
      map.setView([31.7917, -7.0926], 6);
    });

    // Ø¥Ø¶Ø§ÙØ© ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù„Ù…ÙŠ
    document.querySelector('.header-icons').children[1].addEventListener('click', () => {
      scientificMode = !scientificMode;
      const icon = document.querySelector('.header-icons').children[1];
      const modeText = document.querySelector('.mode-toggle');
      
      if (scientificMode) {
        icon.innerHTML = '<i>ğŸ”¬</i>';
        modeText.textContent = 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù„Ù…ÙŠ';
        document.querySelector('.info-text').textContent = 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù„Ù…ÙŠ Ù…ÙØ¹Ù„ - ØªØ­Ù„ÙŠÙ„ Ù…ØªÙ‚Ø¯Ù… Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØ§Ù†ÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ';
      } else {
        icon.innerHTML = '<i>ğŸ“Š</i>';
        modeText.textContent = 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ';
        document.querySelector('.info-text').textContent = 'Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£ÙŠ Ù†Ù‚Ø·Ø© ÙÙŠ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ';
      }
    });

    // Ø¥Ø¶Ø§ÙØ© ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©
    document.querySelector('.header-icons').children[2].addEventListener('click', () => {
      const center = map.getCenter();
      const zoom = map.getZoom();
      const shareUrl = `${window.location.href.split('?')[0]}?lat=${center.lat.toFixed(6)}&lng=${center.lng.toFixed(6)}&zoom=${zoom}`;
      
      if (navigator.share) {
        navigator.share({
          title: 'Ù…Ù†ØµØ© Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ Ø§Ù„Ø¹Ù„Ù…ÙŠØ©',
          text: 'Ø§Ù†Ø¸Ø± Ù‡Ø°Ù‡ Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ù…Ø«ÙŠØ±Ø© Ù„Ù„Ø§Ù‡ØªÙ…Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© Ù…Ø¹ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù„Ù…ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„',
          url: shareUrl
        });
      } else {
        navigator.clipboard.writeText(shareUrl).then(() => {
          alert('ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©!');
        });
      }
    });
  </script>
</body>
</html>
