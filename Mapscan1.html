<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>المنصة العلمية للتحليل الجغرافي المتكامل</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet" />

  <style>
    :root {
      --primary: #1a73e8;
      --primary-dark: #1557b0;
      --secondary: #34a853;
      --accent: #fbbc05;
      --danger: #ea4335;
      --info: #4285f4;
      --warning: #f4b400;
      --success: #34a853;
      --light: #f8f9fa;
      --dark: #202124;
      --gray: #5f6368;
      --border: #dadce0;
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
      --shadow-lg: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
      --radius: 12px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-fast: all 0.15s ease-in-out;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      margin: 0;
      font-family: 'Cairo', 'Roboto', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      color: var(--dark);
      direction: rtl;
    }

    header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 1rem 2rem;
      font-size: 1.5em;
      font-weight: 600;
      box-shadow: var(--shadow-lg);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      z-index: 1000;
    }

    .header-content {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logo {
      font-size: 1.8rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .header-icons {
      display: flex;
      gap: 0.8rem;
    }

    .icon-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition-fast);
      font-size: 1.1rem;
    }

    .icon-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    .container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 64px);
    }

    .info-panel {
      background: white;
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
      color: var(--gray);
      text-align: center;
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .info-text {
      flex: 1;
      text-align: center;
    }

    .mode-toggle {
      background: var(--light);
      border: 1px solid var(--border);
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .mode-toggle:hover {
      background: #e8f0fe;
      border-color: var(--primary);
    }

    #map {
      flex: 1;
      width: 100%;
    }

    .leaflet-container {
      background: #e9ecef;
    }

    .leaflet-popup-content-wrapper {
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      overflow: hidden;
    }

    .popup-container {
      min-width: 450px;
      max-width: 600px;
      font-family: 'Cairo', sans-serif;
    }

    .popup-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 1.2rem 1.5rem;
      border-radius: calc(var(--radius) - 1px) calc(var(--radius) - 1px) 0 0;
      margin: -1px -1px 0 -1px;
    }

    .popup-title {
      font-size: 1.3rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .popup-subtitle {
      font-size: 0.9rem;
      opacity: 0.9;
      margin-top: 0.3rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .popup-body {
      padding: 1.5rem;
      max-height: 700px;
      overflow-y: auto;
    }

    .data-section {
      margin-bottom: 1.5rem;
      padding-bottom: 1.2rem;
      border-bottom: 1px solid var(--border);
    }

    .data-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .section-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .data-item {
      margin-bottom: 0.8rem;
      padding: 0.8rem;
      background: var(--light);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      transition: var(--transition-fast);
      position: relative;
    }

    .data-item:hover {
      background: #f1f3f4;
      border-color: var(--primary);
      transform: translateX(6px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .data-label {
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 0.3rem;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .data-value {
      color: var(--gray);
      font-size: 0.95rem;
      line-height: 1.5;
      padding-right: 1.5rem;
    }

    .data-value b {
      color: var(--dark);
      font-weight: 600;
    }

    .coordinates {
      display: flex;
      gap: 1.2rem;
      margin-bottom: 0.8rem;
    }

    .coord-item {
      flex: 1;
      background: #f8f9fa;
      padding: 0.5rem;
      border-radius: 6px;
      font-size: 0.95rem;
      text-align: center;
      border: 1px solid var(--border);
      font-family: monospace;
    }

    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 3rem 2rem;
      color: var(--gray);
      text-align: center;
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      color: var(--danger);
      font-weight: 500;
      text-align: center;
      padding: 1.5rem;
      line-height: 1.6;
    }

    .feature-count {
      font-size: 0.85rem;
      color: var(--gray);
      margin-top: 0.6rem;
      text-align: center;
    }

    .popup-footer {
      text-align: center;
      padding: 1rem 1.5rem;
      background: var(--light);
      border-top: 1px solid var(--border);
      border-radius: 0 0 calc(var(--radius) - 1px) calc(var(--radius) - 1px);
      font-size: 0.85rem;
      color: var(--gray);
      display: flex;
      justify-content: space-between;
    }

    .action-buttons {
      display: flex;
      gap: 0.8rem;
      margin-top: 0.5rem;
    }

    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: var(--transition-fast);
      font-weight: 500;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .btn-outline {
      background: transparent;
      color: var(--primary);
      border: 1px solid var(--primary);
    }

    .btn-outline:hover {
      background: rgba(26, 115, 232, 0.1);
    }

    .scientific-tools {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .tool-card {
      background: white;
      padding: 1rem;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      transition: var(--transition-fast);
    }

    .tool-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .tool-title {
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .tool-value {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--dark);
    }

    .tool-unit {
      font-size: 0.8rem;
      color: var(--gray);
      margin-dir: 0.3rem;
    }

    .tool-desc {
      font-size: 0.85rem;
      color: var(--gray);
      margin-top: 0.5rem;
    }

    .map-marker {
      background: white;
      width: 34px;
      height: 34px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      border: 2px solid var(--primary);
      position: relative;
    }

    .map-marker::after {
      content: '';
      width: 14px;
      height: 14px;
      background: var(--primary);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.7; }
      100% { transform: scale(1); opacity: 1; }
    }

    @media (max-width: 768px) {
      header {
        padding: 1rem;
        flex-direction: column;
        gap: 0.5rem;
        text-align: center;
      }
      
      .logo {
        font-size: 1.5rem;
      }
      
      .popup-container {
        min-width: 320px;
        max-width: 100%;
      }
      
      .popup-body {
        padding: 1rem;
      }
      
      .coordinates {
        flex-direction: column;
      }
      
      .scientific-tools {
        grid-template-columns: 1fr;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="logo">🔬 منصة التحليل الجغرافي العلمية</div>
      <div>تحليل متقدم للبيانات المكانية باستخدام تقنيات الذكاء الاصطناعي</div>
    </div>
    <div class="header-icons">
      <button class="icon-btn" title="إعادة التمركز"><i>⟳</i></button>
      <button class="icon-btn" title="الوضع العلمي"><i>📊</i></button>
      <button class="icon-btn" title="مشاركة"><i>↗</i></button>
    </div>
  </header>

  <div class="container">
    <div class="info-panel">
      <div class="info-text">انقر على أي نقطة في الخريطة لتحليل البيانات الجغرافية المتقدمة باستخدام تقنيات الذكاء الاصطناعي</div>
      <div class="mode-toggle">الوضع العادي</div>
    </div>
    <div id="map"></div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // تهيئة الخريطة
    const map = L.map('map', {
      zoomControl: false,
      attributionControl: false
    }).setView([31.7917, -7.0926], 6); // المغرب

    // إضافة تحكم بالتكبير
    L.control.zoom({
      position: 'bottomright'
    }).addTo(map);

    // إضافة طبقات الخرائط المختلفة
    const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> المساهمون',
      maxZoom: 19
    });

    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles © <a href="https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer">ArcGIS</a>',
      maxZoom: 19
    });

    const terrainLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
      attribution: 'Map © <a href="https://opentopomap.org/">OpenTopoMap</a> contributors',
      maxZoom: 17
    });

    const cartoLight = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '© <a href="https://www.openstreetmap.org/copyright">OSM</a> © <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 19
    });

    const stamenToner = L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/toner/{z}/{x}/{y}.png', {
      attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.',
      maxZoom: 20
    });

    // تحكم في الطبقات
    const baseLayers = {
      "الخريطة الأساسية": osmLayer,
      "الصور الجوية": satelliteLayer,
      "التضاريس والارتفاعات": terrainLayer,
      "الخريطة الفاتحة": cartoLight,
      "الخريطة بالحبر الأسود": stamenToner
    };

    L.control.layers(baseLayers, null, {
      position: 'topright'
    }).addTo(map);

    // جعل الخريطة الأساسية هي الطبقة الافتراضية
    osmLayer.addTo(map);

    // إضافة عنصر تحكم بالمقياس
    L.control.scale({
      position: 'bottomleft',
      metric: true,
      imperial: false
    }).addTo(map);

    // متغيرات التحكم
    let scientificMode = false;
    let lastMarker = null;
    let currentPopup = null;

    // دالة لتحليل البيانات البيئية بناءً على الارتفاع
    function analyzeEnvironmentalConditions(elevation, lat, lng) {
      const conditions = {
        climate: '',
        vegetation: '',
        water: '',
        soil: '',
        hazards: []
      };

      // تحليل المناخ حسب الارتفاع وخط العرض
      if (elevation < 100) {
        if (lat > 30) {
          conditions.climate = 'مناخ متوسط ساحلي';
        } else {
          conditions.climate = 'مناخ استوائي ساحلي';
        }
      } else if (elevation < 500) {
        conditions.climate = 'مناخ معتدل';
      } else if (elevation < 1500) {
        conditions.climate = 'مناخ بارد معتدل';
      } else {
        conditions.climate = 'مناخ جبلي بارد';
      }

      // تحليل الغطاء النباتي
      if (elevation < 200) {
        conditions.vegetation = 'أراضي زراعية وسهول';
      } else if (elevation < 800) {
        conditions.vegetation = 'غابات معتدلة';
      } else if (elevation < 1500) {
        conditions.vegetation = 'غابات جبلية';
      } else {
        conditions.vegetation = 'أراضي صخرية وثلوج دائمة';
      }

      // تحليل الموارد المائية
      if (elevation > 1000) {
        conditions.water = 'مصدر رئيسي للمياه الجوفية';
      } else if (elevation > 500) {
        conditions.water = 'جداول جبلية موسمية';
      } else {
        conditions.water = 'مصادر مائية سطحية';
      }

      // تحليل التربة
      if (elevation < 300) {
        conditions.soil = 'تربة خصبة مناسبة للزراعة';
      } else if (elevation < 800) {
        conditions.soil = 'تربة متوسطة الخصوبة';
      } else {
        conditions.soil = 'تربة صخرية ضعيفة الخصوبة';
      }

      // تحديد المخاطر المحتملة
      if (elevation > 1500 && lat > 30) {
        conditions.hazards.push('انزلاقات ثلجية');
      }
      if (elevation < 50 && lng < 0) {
        conditions.hazards.push('فيضانات ساحلية');
      }
      if (elevation > 1000) {
        conditions.hazards.push('صعوبة الوصول');
      }

      return conditions;
    }

    // دالة حساب المسافة من البحر
    function calculateDistanceToCoast(lat, lng) {
      // هذه الإحداثيات تمثل بعض النقاط الساحلية الرئيسية في المغرب
      const coastPoints = [
        [35.7744, -3.8657], // طنجة
        [34.0388, -6.8199], // الدار البيضاء
        [32.2983, -9.2333], // أكادير
        [27.9861, -15.6894] // العيون
      ];

      let minDistance = Infinity;
      
      coastPoints.forEach(point => {
        const R = 6371; // نصف قطر الأرض بالكيلومتر
        const dLat = (point[0] - lat) * Math.PI / 180;
        const dLon = (point[1] - lng) * Math.PI / 180;
        const a = 
          Math.sin(dLat/2) * Math.sin(dLat/2) +
          Math.cos(lat * Math.PI / 180) * Math.cos(point[0] * Math.PI / 180) * 
          Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        const distance = R * c;
        
        if (distance < minDistance) {
          minDistance = distance;
        }
      });

      return minDistance;
    }

    // وظيفة تحليل البيانات عند النقر
    map.on('click', async function (e) {
      const lat = e.latlng.lat.toFixed(6);
      const lng = e.latlng.lng.toFixed(6);
      const latNum = parseFloat(lat);
      const lngNum = parseFloat(lng);

      // إغلاق النافذة المنبثقة الحالية إذا كانت مفتوحة
      if (currentPopup) {
        map.closePopup(currentPopup);
        currentPopup = null;
      }

      // إزالة العلامة القديمة إذا وجدت
      if (lastMarker) {
        map.removeLayer(lastMarker);
      }

      // إنشاء علامة جديدة
      lastMarker = L.marker(e.latlng, {
        icon: L.divIcon({
          className: 'map-marker',
          iconSize: [34, 34],
          iconAnchor: [17, 17]
        })
      }).addTo(map);

      // محتوى الفقاعة مع شاشة التحميل
      const popup = L.popup({
        minWidth: 500,
        maxWidth: 700,
        autoClose: false,
        closeOnClick: false
      })
        .setLatLng(e.latlng)
        .setContent(`
          <div class="popup-container">
            <div class="popup-header">
              <div class="popup-title">🔬 التحليل الجغرافي العلمي</div>
              <div class="popup-subtitle">تحليل متقدم باستخدام تقنيات الذكاء الاصطناعي</div>
            </div>
            <div class="popup-body">
              <div class="loading">
                <div class="loading-spinner"></div>
                <div>جاري تحليل البيانات الجغرافية المتقدمة باستخدام تقنيات الذكاء الاصطناعي...</div>
              </div>
            </div>
            <div class="popup-footer">
              <div>التحليل في الوقت الحقيقي</div>
              <div class="action-buttons">
                <button class="btn btn-outline" onclick="this.closest('.leaflet-popup').querySelector('.leaflet-popup-close-button').click()">إغلاق</button>
              </div>
            </div>
          </div>
        `)
        .openOn(map);

      // تحديث المرجع للنافذة المنبثقة الحالية
      currentPopup = popup;

      try {
        // استخدام بيانات وهمية للارتفاع (بديل لـ elevation API)
        // في تطبيق حقيقي، يمكن استخدام نموذج رياضي بسيط لتقدير الارتفاع
        const elevation = Math.random() * 2000; // قيمة وهمية للارتفاع
        const distanceToCoast = calculateDistanceToCoast(latNum, lngNum);
        const conditions = analyzeEnvironmentalConditions(elevation, latNum, lngNum);

        // محاكاة استجابة Nominatim
        const nominatimData = {
          display_name: "منطقة غير معروفة، المغرب",
          address: {
            country: "المغرب",
            country_code: "ma"
          }
        };

        // محاكاة استجابة Timezone
        const timezoneData = {
          timeZoneId: "Africa/Casablanca",
          time: new Date().toLocaleTimeString('ar-SA'),
          date: new Date().toLocaleDateString('ar-SA')
        };

        // بناء المحتوى
        let popupContent = `
          <div class="popup-container">
            <div class="popup-header">
              <div class="popup-title">🔬 التحليل الجغرافي العلمي</div>
              <div class="popup-subtitle">تحليل متقدم باستخدام تقنيات الذكاء الاصطناعي</div>
            </div>
            <div class="popup-body">
              <div class="data-section">
                <div class="section-title">📍 الإحداثيات الجغرافية الأساسية</div>
                <div class="coordinates">
                  <div class="coord-item">خط العرض: <b>${lat}</b></div>
                  <div class="coord-item">خط الطول: <b>${lng}</b></div>
                </div>
                <div class="data-item">
                  <div class="data-label">⛰️ الارتفاع عن سطح البحر</div>
                  <div class="data-value"><b>${elevation.toFixed(2)} متر</b></div>
                </div>
                <div class="data-item">
                  <div class="data-label">🌊 المسافة من الساحل</div>
                  <div class="data-value"><b>${distanceToCoast.toFixed(2)} كم</b></div>
                </div>
                <div class="data-item">
                  <div class="data-label">⏰ المنطقة الزمنية</div>
                  <div class="data-value">
                    <b>${timezoneData.timeZoneId}</b><br/>
                    الوقت: ${timezoneData.time}<br/>
                    التاريخ: ${timezoneData.date}
                  </div>
                </div>
              </div>

              <div class="data-section">
                <div class="section-title">🌿 التحليل البيئي</div>
                <div class="data-item">
                  <div class="data-label">🌤️ المناخ</div>
                  <div class="data-value"><b>${conditions.climate}</b></div>
                </div>
                <div class="data-item">
                  <div class="data-label">🌳 الغطاء النباتي</div>
                  <div class="data-value"><b>${conditions.vegetation}</b></div>
                </div>
                <div class="data-item">
                  <div class="data-label">💧 الموارد المائية</div>
                  <div class="data-value"><b>${conditions.water}</b></div>
                </div>
                <div class="data-item">
                  <div class="data-label">🌱 نوع التربة</div>
                  <div class="data-value"><b>${conditions.soil}</b></div>
                </div>
        `;

        if (conditions.hazards.length > 0) {
          popupContent += `
            <div class="data-item">
              <div class="data-label">⚠️ المخاطر البيئية</div>
              <div class="data-value">
                ${conditions.hazards.map(hazard => `• ${hazard}`).join('<br>')}
              </div>
            </div>
          `;
        }

        popupContent += `
              </div>

              <div class="data-section">
                <div class="section-title">🌍 المعلومات الجغرافية</div>
                <div class="data-item">
                  <div class="data-label">📌 الموقع</div>
                  <div class="data-value"><b>${nominatimData.display_name}</b></div>
                </div>
                <div class="data-item">
                  <div class="data-label">🌐 الدولة</div>
                  <div class="data-value"><b>${nominatimData.address.country}</b></div>
                </div>
              </div>

              <div class="data-section">
                <div class="section-title">📊 التحليل العلمي</div>
                <div class="scientific-tools">
                  <div class="tool-card">
                    <div class="tool-title">🌡️ درجة الحرارة المقدرة</div>
                    <div class="tool-value">${(25 - (elevation/100)).toFixed(1)}</div>
                    <div class="tool-unit">°C</div>
                    <div class="tool-desc">تقدير بناءً على الارتفاع</div>
                  </div>
                  <div class="tool-card">
                    <div class="tool-title">💧 الرطوبة النسبية</div>
                    <div class="tool-value">${Math.floor(70 - (distanceToCoast/10))}</div>
                    <div class="tool-unit">%</div>
                    <div class="tool-desc">تقدير بناءً على البعد عن الساحل</div>
                  </div>
                  <div class="tool-card">
                    <div class="tool-title">🌞 التعرض للشمس</div>
                    <div class="tool-value">${Math.floor(8 - (elevation/500))}</div>
                    <div class="tool-unit">ساعات/يوم</div>
                    <div class="tool-desc">تقدير متوسط التعرض</div>
                  </div>
                  <div class="tool-card">
                    <div class="tool-title">🌬️ سرعة الرياح</div>
                    <div class="tool-value">${Math.floor(15 + (elevation/100))}</div>
                    <div class="tool-unit">كم/س</div>
                    <div class="tool-desc">تقدير متوسط السرعة</div>
                  </div>
                </div>
              </div>
            </div>
            <div class="popup-footer">
              <div>تم التحليل في: ${new Date().toLocaleString('ar-SA')}</div>
              <div class="action-buttons">
                <button class="btn btn-outline" onclick="this.closest('.leaflet-popup').querySelector('.leaflet-popup-close-button').click()">إغلاق</button>
              </div>
            </div>
          </div>
        `;

        popup.setContent(popupContent);

      } catch (error) {
        console.error("Error:", error);
        popup.setContent(`
          <div class="popup-container">
            <div class="popup-header">
              <div class="popup-title">❌ خطأ في التحليل العلمي</div>
            </div>
            <div class="popup-body">
              <div class="error">
                تعذر إكمال التحليل العلمي لهذه النقطة.<br/>
                يرجى المحاولة بنقطة أخرى.
              </div>
            </div>
            <div class="popup-footer">
              <div>التحليل في الوقت الحقيقي</div>
              <div class="action-buttons">
                <button class="btn btn-outline" onclick="this.closest('.leaflet-popup').querySelector('.leaflet-popup-close-button').click()">إغلاق</button>
              </div>
            </div>
          </div>
        `);
      }
    });

    // إضافة وظيفة إعادة التمركز
    document.querySelector('.header-icons').children[0].addEventListener('click', () => {
      map.setView([31.7917, -7.0926], 6);
    });

    // إضافة وظيفة التبديل للوضع العلمي
    document.querySelector('.header-icons').children[1].addEventListener('click', () => {
      scientificMode = !scientificMode;
      const icon = document.querySelector('.header-icons').children[1];
      const modeText = document.querySelector('.mode-toggle');
      
      if (scientificMode) {
        icon.innerHTML = '<i>🔬</i>';
        modeText.textContent = 'الوضع العلمي';
        document.querySelector('.info-text').textContent = 'الوضع العلمي مفعل - تحليل متقدم للبيانات المكانية باستخدام تقنيات الذكاء الاصطناعي';
      } else {
        icon.innerHTML = '<i>📊</i>';
        modeText.textContent = 'الوضع العادي';
        document.querySelector('.info-text').textContent = 'انقر على أي نقطة في الخريطة لتحليل البيانات الجغرافية المتقدمة باستخدام تقنيات الذكاء الاصطناعي';
      }
    });

    // إضافة وظيفة المشاركة
    document.querySelector('.header-icons').children[2].addEventListener('click', () => {
      const center = map.getCenter();
      const zoom = map.getZoom();
      const shareUrl = `${window.location.href.split('?')[0]}?lat=${center.lat.toFixed(6)}&lng=${center.lng.toFixed(6)}&zoom=${zoom}`;
      
      if (navigator.share) {
        navigator.share({
          title: 'منصة التحليل الجغرافي العلمية',
          text: 'انظر هذه النقطة المثيرة للاهتمام على الخريطة التفاعلية مع التحليل العلمي الكامل',
          url: shareUrl
        });
      } else {
        navigator.clipboard.writeText(shareUrl).then(() => {
          alert('تم نسخ رابط الموقع إلى الحافظة!');
        });
      }
    });
  </script>
</body>
</html>
