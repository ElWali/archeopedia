<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ArchaeoMapper Pro: AI-Powered Satellite Archaeology</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <!-- Leaflet Draw CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
      height: 100%;
      overflow: hidden;
    }
    #map {
      height: 100vh;
      width: 100%;
    }
    .panel {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      max-width: 340px;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }
    .panel h2 {
      margin: 0 0 10px 0;
      font-size: 1.3em;
      color: #1a3a5f;
    }
    .panel p {
      margin: 5px 0;
      font-size: 0.9em;
      color: #444;
    }
    .btn {
      background: #1a73e8; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.9em; margin: 5px 0; display: block; width: 100%;
    }
    .btn:hover { background: #0d62c9; }
    .btn-small {
      padding: 6px 10px; font-size: 0.8em; display: inline-block; margin: 2px;
    }
    .loading {
      color: #1a73e8;
      font-weight: 600;
      display: none;
    }
    .legend {
      background: white;
      padding: 8px;
      border-radius: 6px;
      font-size: 0.85em;
      box-shadow: 0 1px 5px rgba(0,0,0,0.1);
      margin-top: 10px;
    }
    .legend-item {
      display: flex; align-items: center; margin: 4px 0;
    }
    .legend-color {
      width: 16px; height: 16px; display: inline-block; margin-right: 8px; border: 1px solid #ccc;
    }
    .detection-result {
      margin-top: 10px; padding: 8px; background: #f0f8ff; border-radius: 6px; font-size: 0.85em;
    }
    .tab {
      overflow: hidden;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-bottom: 10px;
    }
    .tab button {
      background-color: inherit;
      float: left;
      border: none;
      outline: none;
      cursor: pointer;
      padding: 8px 12px;
      transition: 0.3s;
      font-size: 0.9em;
    }
    .tab button:hover {
      background-color: #ddd;
    }
    .tab button.active {
      background-color: #1a73e8;
      color: white;
    }
    .tabcontent {
      display: none;
      padding: 10px;
      border-top: none;
    }
    .tabcontent.active {
      display: block;
    }
    .feature-highlight {
      stroke: #ff0000;
      stroke-width: 3;
      stroke-dasharray: 5,5;
      fill: none;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Control Panel -->
  <div class="panel">
    <div class="tab">
      <button class="tablinks active" onclick="openTab(event, 'Analysis')">Analysis</button>
      <button class="tablinks" onclick="openTab(event, 'Layers')">Layers</button>
      <button class="tablinks" onclick="openTab(event, 'Info')">Info</button>
    </div>

    <div id="Analysis" class="tabcontent active">
      <h2>AI Archaeology Detection</h2>
      <p>Analyze areas for potential archaeological features using satellite data.</p>
      
      <button id="enableDrawing" class="btn btn-small">ðŸŽ¯ Define Area</button>
      <button id="runAnalysis" class="btn" disabled>ðŸš€ Run AI Analysis</button>
      
      <div id="analysisResult" class="detection-result" style="display: none;">
        <h4>AI Detection Results</h4>
        <p><strong>Geometric Features:</strong> <span id="geometricCount">3</span></p>
        <p><strong>Linear Features:</strong> <span id="linearCount">2</span></p>
        <p><strong>Soil Anomalies:</strong> <span id="soilCount">1</span></p>
        <p><strong>Confidence:</strong> <span id="confidence">78%</span></p>
        <button id="showHighlights" class="btn-small" style="margin-top: 5px;">Show Highlights</button>
      </div>
    </div>

    <div id="Layers" class="tabcontent">
      <h2>Satellite Layers</h2>
      <button id="naturalColor" class="btn btn-small">RGBO (Natural)</button>
      <button id="falseColor" class="btn btn-small">SWIR-NIR-Red</button>
      <button id="vegetation" class="btn btn-small">NDVI</button>
      <button id="moisture" class="btn btn-small">Moisture Index</button>
      <button id="elevation" class="btn btn-small">Elevation</button>
    </div>

    <div id="Info" class="tabcontent">
      <h2>How It Works</h2>
      <p>This tool simulates real satellite archaeology analysis using:</p>
      <ul style="font-size: 0.85em; margin: 5px 0;">
        <li>False color composites to reveal subsurface features</li>
        <li>Edge detection algorithms to find geometric patterns</li>
        <li>Vegetation indices to detect crop marks</li>
      </ul>
      <p style="font-size: 0.8em; color: #666; margin-top: 10px;">Note: For real Earth Engine integration, contact us for API access.</p>
    </div>
  </div>

  <!-- Loading Indicator -->
  <div id="loading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255,255,255,0.9); padding: 20px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); z-index: 2000; display: none;">
    <h3>Processing Data...</h3>
    <p id="loadingText">Analyzing satellite imagery</p>
    <div class="loading" style="display: block;">ðŸ”„ Applying AI detection algorithms...</div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <!-- Leaflet Draw JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  <!-- Turf.js for spatial analysis -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <script>
    // Initialize map
    const map = L.map('map', {
      zoomControl: false
    }).setView([33.5, 44.0], 7);

    // Add zoom control
    L.control.zoom({position: 'bottomright'}).addTo(map);

    // Base layers
    const naturalLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 19
    });

    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles &copy; Esri'
    });

    // Custom overlay layers (simulated)
    const falseColorLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      opacity: 0.7,
      name: 'FalseColor'
    });

    const ndviLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      opacity: 0.6,
      name: 'NDVI'
    });

    const moistureLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      opacity: 0.6,
      name: 'Moisture'
    });

    const elevationLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      opacity: 0.5,
      name: 'Elevation'
    });

    // Add default base layer
    naturalLayer.addTo(map);

    // Layer control
    const baseLayers = {
      "Natural Color": naturalLayer,
      "Satellite": satelliteLayer
    };

    const overlays = {
      "False Color (SWIR-NIR-Red)": falseColorLayer,
      "Vegetation (NDVI)": ndviLayer,
      "Moisture Index": moistureLayer,
      "Elevation": elevationLayer
    };

    // Drawing control
    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    const drawControl = new L.Control.Draw({
      edit: {
        featureGroup: drawnItems,
        remove: true
      },
      draw: {
        polygon: true,
        rectangle: true,
        circle: false,
        marker: false,
        polyline: false,
        circlemarker: false
      }
    });
    map.addControl(drawControl);

    // Variables
    let analysisArea = null;
    let aiHighlights = [];
    let currentOverlay = null;

    // Tab functionality
    function openTab(evt, tabName) {
      const tabcontent = document.getElementsByClassName("tabcontent");
      for (let i = 0; i < tabcontent.length; i++) {
        tabcontent[i].className = tabcontent[i].className.replace(" active", "");
      }
      const tablinks = document.getElementsByClassName("tablinks");
      for (let i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
      }
      document.getElementById(tabName).className += " active";
      evt.currentTarget.className += " active";
    }

    // Drawing events
    map.on(L.Draw.Event.CREATED, function(event) {
      const layer = event.layer;
      drawnItems.addLayer(layer);
      analysisArea = layer;
      document.getElementById('runAnalysis').disabled = false;
    });

    // Button actions
    document.getElementById('enableDrawing').addEventListener('click', function() {
      const drawPolygon = new L.Draw.Polygon(map, drawControl.options.polygon);
      drawPolygon.enable();
    });

    document.getElementById('runAnalysis').addEventListener('click', async function() {
      if (!analysisArea) {
        alert('Please define an analysis area first');
        return;
      }

      // Show loading
      document.getElementById('loading').style.display = 'block';
      document.getElementById('loadingText').textContent = 'Processing satellite data...';

      // Simulate AI analysis (in real app, this would call ML API)
      setTimeout(() => {
        // Generate random but plausible results
        const results = {
          geometricCount: Math.floor(Math.random() * 5) + 1,
          linearCount: Math.floor(Math.random() * 4) + 1,
          soilCount: Math.floor(Math.random() * 3) + 1,
          confidence: Math.floor(Math.random() * 25) + 75 + '%'
        };

        // Update results
        document.getElementById('geometricCount').textContent = results.geometricCount;
        document.getElementById('linearCount').textContent = results.linearCount;
        document.getElementById('soilCount').textContent = results.soilCount;
        document.getElementById('confidence').textContent = results.confidence;
        document.getElementById('analysisResult').style.display = 'block';

        // Create AI highlights (simulated)
        createAIHighlights();

        document.getElementById('loading').style.display = 'none';
        document.getElementById('loadingText').textContent = 'Analyzing satellite imagery';
      }, 2500);
    });

    // Create AI detection highlights
    function createAIHighlights() {
      // Clear previous highlights
      clearAIHighlights();
      
      if (!analysisArea) return;

      // Get bounds of analysis area
      const bounds = analysisArea.getBounds();
      const center = bounds.getCenter();
      const sw = bounds.getSouthWest();
      const ne = bounds.getNorthEast();
      
      // Create simulated detection points
      const featureCount = 5 + Math.floor(Math.random() * 3);
      
      for (let i = 0; i < featureCount; i++) {
        // Random position within bounds
        const lat = sw.lat + (ne.lat - sw.lat) * Math.random();
        const lng = ne.lng - (ne.lng - sw.lng) * Math.random();
        
        // Random size
        const radius = 500 + Math.random() * 1000;
        
        // Create highlight circle
        const highlight = L.circle([lat, lng], {
          radius: radius,
          color: '#ff0000',
          weight: 3,
          opacity: 0.8,
          fillOpacity: 0.1,
          dashArray: '10,10'
        }).addTo(map);
        
        // Add popup
        highlight.bindPopup(`<b>Potential Archaeological Feature</b><br>
          Type: Geometric Structure<br>
          Confidence: ${Math.floor(Math.random() * 25) + 75}%<br>
          Size: ~${Math.floor(radius*2)}m diameter`);
        
        aiHighlights.push(highlight);
      }
    }

    // Show/hide AI highlights
    document.getElementById('showHighlights').addEventListener('click', function() {
      if (aiHighlights.length === 0 && analysisArea) {
        createAIHighlights();
      }
      // Zoom to area
      if (analysisArea) {
        map.fitBounds(analysisArea.getBounds(), {padding: [50, 50]});
      }
    });

    // Clear AI highlights
    function clearAIHighlights() {
      aiHighlights.forEach(highlight => {
        map.removeLayer(highlight);
      });
      aiHighlights = [];
    }

    // Layer buttons
    document.getElementById('naturalColor').addEventListener('click', function() {
      map.eachLayer(layer => {
        if (layer.options.name && layer.options.name.includes('Color')) {
          map.removeLayer(layer);
        }
      });
      naturalLayer.addTo(map);
    });

    document.getElementById('falseColor').addEventListener('click', function() {
      map.eachLayer(layer => {
        if (layer.options.name && layer.options.name.includes('Color')) {
          map.removeLayer(layer);
        }
      });
      falseColorLayer.addTo(map);
    });

    document.getElementById('vegetation').addEventListener('click', function() {
      map.eachLayer(layer => {
        if (layer.options.name && layer.options.name.includes('NDVI')) {
          map.removeLayer(layer);
        }
      });
      ndviLayer.addTo(map);
    });

    document.getElementById('moisture').addEventListener('click', function() {
      map.eachLayer(layer => {
        if (layer.options.name && layer.options.name.includes('Moisture')) {
          map.removeLayer(layer);
        }
      });
      moistureLayer.addTo(map);
    });

    document.getElementById('elevation').addEventListener('click', function() {
      map.eachLayer(layer => {
        if (layer.options.name && layer.options.name.includes('Elevation')) {
          map.removeLayer(layer);
        }
      });
      elevationLayer.addTo(map);
    });

    // Instructions
    console.log('ArchaeoMapper Pro loaded. Click "Define Area" to start analysis.');
  </script>
</body>
</html>
