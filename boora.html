<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Little Prince: The Definitive Journey</title>
    
    <style>
        :root {
            --primary-text: #E0E0E0; --secondary-text: #BDBDBD; --background-color: rgba(20, 20, 30, 0.85);
            --border-color: rgba(255, 255, 255, 0.2); --accent-color: #FBC02D;
        }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #000; color: var(--primary-text); overflow: hidden; }
        #bg { position: fixed; top: 0; left: 0; outline: none; }
        .ui-panel { position: absolute; background-color: var(--background-color); backdrop-filter: blur(10px); border: 1px solid var(--border-color); border-radius: 8px; z-index: 10; }
        #info-panel { top: 20px; left: 20px; width: 320px; padding: 20px; transition: transform 0.5s ease-out, opacity 0.5s ease-out; transform: translateX(-120%); opacity: 0; }
        #info-panel.visible { transform: translateX(0); opacity: 1; }
        #info-panel h2 { margin-top: 0; font-size: 1.5em; }
        #info-panel p { font-size: 1em; line-height: 1.6; color: var(--secondary-text); }
        #close-panel-btn, #return-map-btn { position: absolute; top: 10px; right: 15px; background: none; border: none; color: var(--primary-text); font-size: 2em; cursor: pointer; line-height: 1; transition: opacity 0.3s; }
        #return-map-btn { right: auto; left: 15px; font-size: 1.8em; opacity: 0; pointer-events: none; }
        #return-map-btn.visible { opacity: 1; pointer-events: auto; }
        .narrative-text { font-style: italic; color: var(--accent-color); margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); }
        #interaction-container { margin-top: 20px; }
        .interaction-btn { display: block; width: 100%; padding: 12px; margin-top: 10px; background-color: var(--accent-color); color: #000; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; font-weight: bold; transition: background-color 0.3s, transform 0.1s; }
        .interaction-btn:hover { background-color: #FDD835; }
        .interaction-btn:active { transform: scale(0.98); }
        .interaction-btn:disabled { background-color: #555; color: #999; cursor: not-allowed; }
        #timeline { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; padding: 10px 20px; transition: opacity 0.5s; }
        #timeline.inactive { opacity: 0.5; }
        .timeline-item { padding: 8px 16px; cursor: pointer; transition: background-color 0.3s, color 0.3s; border-radius: 5px; color: var(--secondary-text); }
        .timeline-item:hover, .timeline-item.active { background-color: rgba(255, 255, 255, 0.1); color: var(--primary-text); }
        #loading-screen { position: fixed; width: 100%; height: 100%; background-color: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; transition: opacity 1.5s ease; }
        .loader { border: 4px solid rgba(255, 255, 255, 0.2); border-left-color: #fff; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <canvas id="bg"></canvas>
    <div id="info-panel" class="ui-panel">
        <button id="close-panel-btn">&times;</button>
        <button id="return-map-btn" title="Return to Celestial Map">&#8617;</button>
        <h2 id="panel-title"></h2>
        <p id="panel-description"></p>
        <div id="interaction-container"></div>
        <p id="narrative-text" class="narrative-text"></p>
    </div>
    <div id="timeline" class="ui-panel"></div>
    <div id="loading-screen"><div class="loader"></div><p>The stars are coming into view...</p></div>

    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.150.1/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.150.1/examples/jsm/" } }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        const PLANET_DATA = { /* ... same data as before ... */ };

        // --- NEW: SoundManager ---
        class SoundManager {
            constructor(camera) {
                this.listener = new THREE.AudioListener();
                camera.add(this.listener);
                this.sounds = {};
                this.ambientSound = null;
            }
            load(name, path, loop = false, volume = 0.5) {
                const sound = new THREE.Audio(this.listener);
                const audioLoader = new THREE.AudioLoader();
                audioLoader.load(path, (buffer) => {
                    sound.setBuffer(buffer);
                    sound.setLoop(loop);
                    sound.setVolume(volume);
                    this.sounds[name] = sound;
                    if (name === 'ambient' && !this.ambientSound) {
                        this.ambientSound = sound;
                        this.ambientSound.play();
                    }
                });
            }
            play(name) {
                if (this.sounds[name] && !this.sounds[name].isPlaying) {
                    this.sounds[name].play();
                }
            }
        }
        
        // Helper to generate more advanced procedural textures
        function createPlanetTexture(color, hasClouds = false) {
            const canvas = document.createElement('canvas');
            const size = 512;
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext('2d');
            
            // Base color with noise
            ctx.fillStyle = `#${new THREE.Color(color).getHexString()}`;
            ctx.fillRect(0, 0, size, size);
            const imageData = ctx.getImageData(0, 0, size, size);
            const data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
                const noise = Math.random() * 40 - 20;
                data[i] += noise;
                data[i+1] += noise;
                data[i+2] += noise;
            }
            ctx.putImageData(imageData, 0, 0);

            if (hasClouds) {
                // Return two canvases for multi-layered texturing
                const cloudCanvas = document.createElement('canvas');
                cloudCanvas.width = size;
                cloudCanvas.height = size;
                const cloudCtx = cloudCanvas.getContext('2d');
                cloudCtx.fillStyle = 'white';
                for(let i=0; i<30; i++) {
                    cloudCtx.globalAlpha = Math.random() * 0.5 + 0.2;
                    cloudCtx.beginPath();
                    cloudCtx.arc(Math.random() * size, Math.random() * size, Math.random() * size * 0.2, 0, Math.PI * 2);
                    cloudCtx.fill();
                }
                return { base: new THREE.CanvasTexture(canvas), clouds: new THREE.CanvasTexture(cloudCanvas) };
            }
            
            return { base: new THREE.CanvasTexture(canvas) };
        }

        class LittlePrinceExperience {
            constructor() {
                // ... same state variables and core components ...
                // this.soundManager = new SoundManager(this.camera);
            }
            
            init() {
                // ... same init logic ...
                
                // Load Sounds (NOTE: These are placeholder URLs. They won't work without real audio files.)
                // this.soundManager.load('ambient', 'path/to/ambient.mp3', true, 0.2);
                // this.soundManager.load('ui_click', 'path/to/click.wav', false, 0.8);
                // this.soundManager.load('panel_swoosh', 'path/to/swoosh.wav', false, 0.6);
                // this.soundManager.load('king_chime', 'path/to/chime.wav');
                // this.soundManager.load('fox_twinkle', 'path/to/twinkle.wav');
            }

            populateScene() {
                // ... same starfield and asteroid belt logic ...

                for (const [name, data] of Object.entries(PLANET_DATA)) {
                    const textures = createPlanetTexture(data.color, name === 'Earth');
                    const body = new THREE.Mesh(
                        new THREE.SphereGeometry(data.size, 64, 64),
                        new THREE.MeshStandardMaterial({ map: textures.base, emissive: data.emissive || 0x000000, emissiveIntensity: 1.5 })
                    );
                    body.position.set(...data.position);
                    body.name = name;
                    this.scene.add(body);
                    this.celestialBodies.set(name, body);

                    // Add unique features and characters
                    if (name === "Earth") this.addEarthFeatures(body, textures.clouds);
                    if (name === "B-612") this.addCharacter(body, 'prince');
                    if (name === "The King's Planet") this.addCharacter(body, 'king');
                    if (name === "The Vain Man's Planet") this.addCharacter(body, 'vain_man');
                }
            }

            addEarthFeatures(planet, cloudTexture) {
                const cloudMesh = new THREE.Mesh(
                    new THREE.SphereGeometry(planet.geometry.parameters.radius + 0.05, 64, 64),
                    new THREE.MeshStandardMaterial({ map: cloudTexture, transparent: true, opacity: 0.6, blending: THREE.AdditiveBlending })
                );
                planet.add(cloudMesh);
                planet.userData.clouds = cloudMesh;
            }

            addCharacter(planet, type) {
                const character = new THREE.Group();
                const bodyMat = new THREE.MeshStandardMaterial({ flatShading: true });
                let head, bodyMesh;

                switch(type) {
                    case 'prince':
                        bodyMat.color.set(0x2E8B57);
                        bodyMesh = new THREE.Mesh(new THREE.ConeGeometry(0.1, 0.4, 8), bodyMat);
                        head = new THREE.Mesh(new THREE.IcosahedronGeometry(0.15, 0), new THREE.MeshStandardMaterial({color: 0xFFDBAC}));
                        head.position.y = 0.25;
                        const scarf = new THREE.Mesh(new THREE.TorusGeometry(0.12, 0.03, 8, 16), new THREE.MeshStandardMaterial({color: 0xFFD700}));
                        scarf.position.y = 0.2;
                        scarf.rotation.x = Math.PI / 2;
                        character.add(scarf);
                        break;
                    case 'king':
                        bodyMat.color.set(0x800000);
                        bodyMesh = new THREE.Mesh(new THREE.ConeGeometry(0.2, 0.6, 8), bodyMat);
                        head = new THREE.Mesh(new THREE.SphereGeometry(0.1, 16, 16), new THREE.MeshStandardMaterial({color: 0xFFDBAC}));
                        head.position.y = 0.3;
                        break;
                    case 'vain_man':
                        bodyMat.color.set(0x4B0082);
                        bodyMesh = new THREE.Mesh(new THREE.CylinderGeometry(0.15, 0.15, 0.5, 8), bodyMat);
                        head = new THREE.Mesh(new THREE.SphereGeometry(0.1, 16, 16), new THREE.MeshStandardMaterial({color: 0xFFDBAC}));
                        head.position.y = 0.3;
                        const hat = new THREE.Mesh(new THREE.CylinderGeometry(0.15, 0.15, 0.05, 16), new THREE.MeshStandardMaterial({color: 0x333333}));
                        hat.position.y = 0.4;
                        character.add(hat);
                        break;
                }
                character.add(bodyMesh, head);
                character.position.y = planet.geometry.parameters.radius;
                planet.add(character);
                planet.userData.character = character;
            }
            
            handleInteraction(action) {
                // ... same logic but with sound and animation hooks ...
                const activePlanet = this.celestialBodies.get(this.focusedPlanet.name);

                switch(action) {
                    case "clap":
                        // this.soundManager.play('ui_click');
                        gsap.to(activePlanet.userData.character.rotation, { duration: 0.5, y: "+=6.28", ease: "power2.out" });
                        gsap.to(activePlanet.userData.character.children.find(c => c.geometry.type.includes("Cylinder")).rotation, { duration: 0.2, x: "-=0.5", yoyo: true, repeat: 1, ease: "sine.out" });
                        break;
                    case "tameFox":
                        // ... same logic but update narrative text ...
                        const narrativeEl = document.getElementById('narrative-text');
                        this.foxTameCount++;
                        if (this.foxTameCount === 1) narrativeEl.textContent = `"To me, you are still nothing more than a little boy who is just like a hundred thousand other little boys. And I have no need of you. And you, on your part, have no need of me... But if you tame me, then we shall need each other."`;
                        else if (this.foxTameCount === 2) narrativeEl.textContent = `"One only understands the things that one tames," said the fox. "Men have no more time to understand anything. They buy things all ready made at the shops. But there is no shop anywhere where one can buy friendship, and so men have no friends any more."`;
                        else {
                            narrativeEl.textContent = `"To you, I am nothing more than a fox like a hundred thousand other foxes. But if you tame me, I shall be unique in all the world." The wheat field has appeared.`;
                        }
                        break;
                    // ... other cases ...
                }
            }
            
            animate() {
                // ... same core animation loop ...
                this.celestialBodies.forEach((body, name) => {
                    // ...
                    if (body.userData.clouds) body.userData.clouds.rotation.y += 0.05 * delta;
                    if (body.userData.character) body.userData.character.rotation.y += 0.2 * delta;
                });
            }

            // ... The rest of the class methods (focus, return, clicks, resize) remain the same robust versions from the previous corrected code ...
        }

        // --- UIManager Class (Handles all DOM interactions, now with narrative text) ---
        class UIManager {
            constructor(timelineCallback, returnCallback) {
                // ... same properties plus narrative text element ...
                this.narrativeText = document.getElementById('narrative-text');
            }
            showPanel(name) {
                // ... same logic ...
                this.narrativeText.textContent = ''; // Clear narrative on new panel
                this.infoPanel.classList.add('visible');
                // this.soundManager.play('panel_swoosh');
            }
            // ... etc ...
        }

        // Kickstart
        window.app = new LittlePrinceExperience();

    </script>
</body>
</html>
