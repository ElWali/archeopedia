<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Little Prince: An Interactive Celestial Journey (Corrected)</title>
    
    <style>
        :root {
            --primary-text: #E0E0E0;
            --secondary-text: #BDBDBD;
            --background-color: rgba(20, 20, 30, 0.85);
            --border-color: rgba(255, 255, 255, 0.2);
            --accent-color: #FBC02D;
        }

        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #000; color: var(--primary-text); overflow: hidden; }
        #bg { position: fixed; top: 0; left: 0; outline: none; }

        .ui-panel { position: absolute; background-color: var(--background-color); backdrop-filter: blur(10px); border: 1px solid var(--border-color); border-radius: 8px; z-index: 10; }

        #info-panel { top: 20px; left: 20px; width: 320px; padding: 20px; transition: transform 0.5s ease-out, opacity 0.5s ease-out; transform: translateX(-120%); opacity: 0; }
        #info-panel.visible { transform: translateX(0); opacity: 1; }
        #info-panel h2 { margin-top: 0; font-size: 1.5em; }
        #info-panel p { font-size: 1em; line-height: 1.6; color: var(--secondary-text); }

        #close-panel-btn, #return-map-btn { position: absolute; top: 10px; right: 15px; background: none; border: none; color: var(--primary-text); font-size: 2em; cursor: pointer; line-height: 1; transition: opacity 0.3s; }
        #return-map-btn { right: auto; left: 15px; font-size: 1.8em; opacity: 0; pointer-events: none; }
        #return-map-btn.visible { opacity: 1; pointer-events: auto; }

        #panel-quote-container { margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color); font-style: italic; }
        #panel-quote-author { display: block; text-align: right; margin-top: 10px; color: #9E9E9E; }
        #interaction-container { margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color); }

        .interaction-btn { display: block; width: 100%; padding: 12px; margin-top: 10px; background-color: var(--accent-color); color: #000; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; font-weight: bold; transition: background-color 0.3s, transform 0.1s; }
        .interaction-btn:hover { background-color: #FDD835; }
        .interaction-btn:active { transform: scale(0.98); }
        .interaction-btn:disabled { background-color: #555; color: #999; cursor: not-allowed; }

        #timeline { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; padding: 10px 20px; }
        .timeline-item { padding: 8px 16px; cursor: pointer; transition: background-color 0.3s, color 0.3s; border-radius: 5px; color: var(--secondary-text); }
        .timeline-item:hover, .timeline-item.active { background-color: rgba(255, 255, 255, 0.1); color: var(--primary-text); }

        #loading-screen { position: fixed; width: 100%; height: 100%; background-color: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; transition: opacity 1.5s ease; }
        .loader { border: 4px solid rgba(255, 255, 255, 0.2); border-left-color: #fff; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <canvas id="bg"></canvas>
    <div id="info-panel" class="ui-panel">
        <button id="close-panel-btn">&times;</button>
        <button id="return-map-btn" title="Return to Celestial Map">&#8617;</button>
        <h2 id="panel-title"></h2>
        <p id="panel-description"></p>
        <div id="interaction-container"></div>
        <div id="panel-quote-container">
            <p id="panel-quote"></p>
            <span id="panel-quote-author"></span>
        </div>
    </div>
    <div id="timeline" class="ui-panel"></div>
    <div id="loading-screen"><div class="loader"></div><p>The stars are coming into view...</p></div>

    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.150.1/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.150.1/examples/jsm/"
        }
    }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        const PLANET_DATA = {
            "Sun": { name: "Sun", size: 10, position: [0, 0, 0], color: 0xFFF4D6, emissive: 0xFFD700 },
            "B-612": { name: "B-612", size: 1, position: [20, 0, 0], color: 0xC2B280, description: "The home of the Little Prince, no bigger than a house. It has three volcanoes and one very special rose.", quote: "It is the time you have wasted for your rose that makes your rose so important.", interactions: [{ text: "Watch the Sunset", action: "sunset" }] },
            "The King's Planet": { name: "The King's Planet", size: 1.5, position: [-35, 5, -10], color: 0x8B4513, description: "This planet was inhabited by a king who claimed to rule over everything. He saw the Prince only as a subject.", quote: "One must command from each what each can perform.", interactions: [{ text: "Command the Sun to Set", action: "commandSunset" }] },
            "The Vain Man's Planet": { name: "The Vain Man's Planet", size: 1.2, position: [50, -8, 20], color: 0xDDA0DD, description: "This planet was inhabited by a conceited man who wanted nothing but admiration.", quote: "The conceited men hear nothing but praise.", interactions: [{ text: "Clap for Me!", action: "clap" }] },
            "The Lamplighter's Planet": { name: "The Lamplighter's Planet", size: 0.8, position: [-60, -10, 40], color: 0x4682B4, description: "The smallest planet of all, with just enough room for a street lamp and a lamplighter. His orders were to extinguish and relight the lamp every minute.", quote: "He is the only one of them all whom I could have made my friend.", interactions: [] },
            "Earth": { name: "Earth", size: 3, position: [-70, 10, -50], color: 0x4B6E89, description: "The seventh planet. It is here the prince met the serpent, the flower, and the fox who taught him what is essential.", quote: "What is essential is invisible to the eye.", interactions: [{ text: "Tame the Fox", action: "tameFox" }] }
        };

        // Helper to generate unique, self-contained planet textures. No external files needed.
        function createPlanetTexture(color) { /* ... same as before ... */ }

        class LittlePrinceExperience {
            constructor() {
                // State Management
                this.STATE = { IDLE: 0, FOCUSED: 1 };
                this.currentState = this.STATE.IDLE;
                this.isTransitioning = false;
                this.focusedPlanet = null;
                this.foxTameCount = 0;

                // Core Components
                this.clock = new THREE.Clock();
                this.canvas = document.getElementById('bg');
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 2000);
                this.renderer = new THREE.WebGLRenderer({ canvas: this.canvas, antialias: true, powerPreference: "high-performance" });
                this.composer = new EffectComposer(this.renderer);
                this.controls = new OrbitControls(this.camera, this.canvas);
                this.raycaster = new THREE.Raycaster();
                this.mouse = new THREE.Vector2();
                this.celestialBodies = new Map();
                
                // UI
                this.uiManager = new UIManager(
                    (name) => this.focusOnPlanet(name),
                    () => this.returnToMapView()
                );

                this.init();
            }
            
            init() {
                this.camera.position.set(0, 30, 150);
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                this.renderer.toneMapping = THREE.ACESFilmicToneMapping;

                // Lighting
                this.ambientLight = new THREE.AmbientLight(0xffffff, 0.1);
                this.directionalLight = new THREE.DirectionalLight(0xffffff, 2.5);
                this.directionalLight.position.set(10, 10, 10);
                this.scene.add(this.ambientLight, this.directionalLight);

                // Post-processing
                this.composer.addPass(new RenderPass(this.scene, this.camera));
                const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 0.5, 0.4, 0.85);
                this.composer.addPass(bloomPass);

                // Controls
                this.controls.enabled = false;
                this.controls.enableDamping = true;
                this.controls.dampingFactor = 0.05;

                // Scene population
                this.populateScene();
                this.uiManager.populateTimeline(PLANET_DATA);

                // Event Listeners
                window.addEventListener('resize', this.onWindowResize.bind(this));
                this.canvas.addEventListener('click', this.onCanvasClick.bind(this));

                this.animate();
            }

            populateScene() {
                // Procedural Starfield
                const starsGeometry = new THREE.BufferGeometry();
                const starVertices = [];
                for (let i = 0; i < 15000; i++) starVertices.push((Math.random() - 0.5) * 2000, (Math.random() - 0.5) * 2000, (Math.random() - 0.5) * 2000);
                starsGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
                this.scene.add(new THREE.Points(starsGeometry, new THREE.PointsMaterial({ color: 0xffffff, size: 0.7, transparent: true, opacity: 0.8 })));

                // Planets
                for (const [name, data] of Object.entries(PLANET_DATA)) {
                    const material = new THREE.MeshStandardMaterial({
                        map: createPlanetTexture(data.color),
                        emissive: data.emissive ? new THREE.Color(data.emissive) : 0x000000,
                        emissiveIntensity: data.emissive ? 1.5 : 0
                    });
                    const body = new THREE.Mesh(new THREE.SphereGeometry(data.size, 64, 64), material);
                    body.position.set(...data.position);
                    body.name = name;
                    this.scene.add(body);
                    this.celestialBodies.set(name, body);

                    if (name === "B-612") this.addB612Features(body);
                    if (name === "The Lamplighter's Planet") this.addLamplighterFeatures(body);
                }
                this.uiManager.hideLoadingScreen();
            }

            focusOnPlanet(name) {
                const planet = this.celestialBodies.get(name);
                if (!planet || this.isTransitioning || this.focusedPlanet === planet) return;

                this.isTransitioning = true;
                this.controls.enabled = false;
                this.uiManager.hidePanel();
                this.focusedPlanet = planet;
                
                const targetPos = planet.position.clone();
                const offset = planet.geometry.parameters.radius * 4;
                const cameraPos = new THREE.Vector3(targetPos.x, targetPos.y + offset / 2, targetPos.z + offset);

                gsap.to(this.camera.position, {
                    duration: 2.5,
                    x: cameraPos.x, y: cameraPos.y, z: cameraPos.z,
                    ease: "power3.inOut",
                    onComplete: () => {
                        this.currentState = this.STATE.FOCUSED;
                        this.isTransitioning = false;
                        this.controls.enabled = true;
                        this.uiManager.showPanel(name);
                        this.uiManager.toggleReturnButton(true);
                    }
                });
                gsap.to(this.controls.target, {
                    duration: 2.5,
                    x: targetPos.x, y: targetPos.y, z: targetPos.z,
                    ease: "power3.inOut"
                });
            }

            returnToMapView() {
                if (this.isTransitioning || this.currentState === this.STATE.IDLE) return;

                this.isTransitioning = true;
                this.controls.enabled = false;
                this.uiManager.hidePanel();
                this.uiManager.toggleReturnButton(false);
                this.focusedPlanet = null;

                gsap.to(this.camera.position, {
                    duration: 2.5, x: 0, y: 30, z: 150, ease: "power3.inOut",
                    onComplete: () => {
                        this.currentState = this.STATE.IDLE;
                        this.isTransitioning = false;
                    }
                });
                gsap.to(this.controls.target, { duration: 2.5, x: 0, y: 0, z: 0, ease: "power3.inOut" });
            }

            handleInteraction(action) {
                // ... Interaction logic remains the same, but with the King's command change
                switch(action) {
                    case "sunset":
                    case "commandSunset": // The King's command now triggers the same effect
                        gsap.to(this.directionalLight.position, { duration: 5, x: -10, y: 0, z: -5, ease: "power2.inOut", yoyo: true, repeat: 1 });
                        gsap.to(this.directionalLight, { duration: 5, intensity: 0.1, ease: "power2.inOut", yoyo: true, repeat: 1 });
                        if (action === "commandSunset") this.uiManager.interactionContainer.innerHTML = "<p>The sun obeys... but at its own pace.</p>";
                        break;
                    // ... other cases remain the same ...
                }
            }

            animate() {
                requestAnimationFrame(this.animate.bind(this));
                const delta = this.clock.getDelta();
                const elapsedTime = this.clock.getElapsedTime();

                this.celestialBodies.forEach((body, name) => {
                    if (name === "Sun") return;
                    const data = PLANET_DATA[name];
                    const speed = 0.5 / Math.sqrt(Math.abs(data.position[0] || 1));
                    const orbitRadius = Math.hypot(data.position[0], data.position[2]);
                    if (this.currentState === this.STATE.IDLE || this.focusedPlanet !== body) {
                        body.position.x = Math.cos(elapsedTime * speed) * orbitRadius;
                        body.position.z = Math.sin(elapsedTime * speed) * orbitRadius;
                    }
                    if (name === "The Lamplighter's Planet") {
                        body.rotation.y += 5 * delta;
                        body.userData.lamp.intensity = (Math.sin(elapsedTime * 20) > 0) ? 5 : 0;
                    } else {
                        body.rotation.y += 0.1 * delta;
                    }
                });

                if (this.controls.enabled) this.controls.update();
                this.composer.render(delta);
            }
            
            // ... Other methods like addB612Features, onCanvasClick, etc. remain largely the same, but are now part of this class ...
            // Dummy implementations for brevity, the logic is the same as the previous full code
            addB612Features(planet) { /* ... */ }
            addLamplighterFeatures(planet) { /* ... */ }
            onCanvasClick(event) { /* ... */ }
            onWindowResize() { /* ... */ }
        }

        // --- UIManager Class (Handles all DOM interactions) ---
        class UIManager {
            constructor(timelineCallback, returnCallback) {
                this.infoPanel = document.getElementById('info-panel');
                this.timeline = document.getElementById('timeline');
                this.interactionContainer = document.getElementById('interaction-container');
                
                document.getElementById('close-panel-btn').onclick = () => this.hidePanel();
                document.getElementById('return-map-btn').onclick = returnCallback;
                this.timelineCallback = timelineCallback;
            }
            // ... Other UI methods remain the same ...
            populateTimeline(data) { /* ... */ }
            showPanel(name) { /* ... */ }
            hidePanel() { /* ... */ }
            toggleReturnButton(visible) { document.getElementById('return-map-btn').classList.toggle('visible', visible); }
            hideLoadingScreen() { /* ... */ }
        }

        // Kickstart the application
        window.app = new LittlePrinceExperience();

    </script>
</body>
</html>
