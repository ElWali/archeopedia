<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ArchaeoMap - Wikidata</title>
  <style>
    html, body, #map {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: sans-serif;
    }
    .ol-popup {
      background: white;
      border-radius: 8px;
      border: 1px solid #ccc;
      padding: 10px;
      min-width: 200px;
    }
  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@latest/ol.css" />
</head>
<body>
  <div id="map"></div>
  <script type="module">
    import Map from 'https://cdn.jsdelivr.net/npm/ol@latest/Map.js';
    import View from 'https://cdn.jsdelivr.net/npm/ol@latest/View.js';
    import TileLayer from 'https://cdn.jsdelivr.net/npm/ol@latest/layer/Tile.js';
    import OSM from 'https://cdn.jsdelivr.net/npm/ol@latest/source/OSM.js';
    import {fromLonLat} from 'https://cdn.jsdelivr.net/npm/ol@latest/proj.js';
    import Feature from 'https://cdn.jsdelivr.net/npm/ol@latest/Feature.js';
    import Point from 'https://cdn.jsdelivr.net/npm/ol@latest/geom/Point.js';
    import VectorLayer from 'https://cdn.jsdelivr.net/npm/ol@latest/layer/Vector.js';
    import VectorSource from 'https://cdn.jsdelivr.net/npm/ol@latest/source/Vector.js';
    import {Icon, Style} from 'https://cdn.jsdelivr.net/npm/ol@latest/style.js';
    import Overlay from 'https://cdn.jsdelivr.net/npm/ol@latest/Overlay.js';

    const vectorSource = new VectorSource();

    const vectorLayer = new VectorLayer({
      source: vectorSource
    });

    const map = new Map({
      target: 'map',
      layers: [
        new TileLayer({
          source: new OSM()
        }),
        vectorLayer
      ],
      view: new View({
        center: fromLonLat([39.8283, 21.4225]), // موقع تقريبي في السعودية
        zoom: 5
      })
    });

    // نافذة منبثقة للموقع الأثري
    const popup = document.createElement('div');
    popup.className = 'ol-popup';
    const overlay = new Overlay({
      element: popup,
      autoPan: true,
      autoPanAnimation: {
        duration: 250,
      },
    });
    map.addOverlay(overlay);

    map.on('singleclick', function(event) {
      overlay.setPosition(undefined);
      map.forEachFeatureAtPixel(event.pixel, function(feature) {
        const label = feature.get('arLabel') || feature.get('label') || '';
        const link = feature.get('link');
        popup.innerHTML = `
          <strong>${label}</strong><br>
          <a href="${link}" target="_blank">ويكي بيانات</a>
        `;
        overlay.setPosition(event.coordinate);
        return true;
      });
    });

    async function loadArchaeologicalSites() {
      try {
        const endpoint = 'https://query.wikidata.org/sparql?query=';
        const query = `
          SELECT ?item ?itemLabel ?itemLabelAr ?coord WHERE {
            ?item wdt:P31 wd:Q839954.
            ?item wdt:P625 ?coord.
            SERVICE wikibase:label { bd:serviceParam wikibase:language "en". }
            ?item rdfs:label ?itemLabelAr .
            FILTER (lang(?itemLabelAr) = "ar")
          }
          LIMIT 1000
        `;
        const url = endpoint + encodeURIComponent(query);
        const headers = { Accept: "application/sparql-results+json" };
        const res = await fetch(url, { headers });
        if (!res.ok) throw new Error("Network response was not ok");
        const data = await res.json();

        for (let entry of data.results.bindings) {
          const coordStr = entry.coord.value.replace('Point(', '').replace(')', '');
          const [lon, lat] = coordStr.split(' ').map(Number);
          const feature = new Feature({
            geometry: new Point(fromLonLat([lon, lat])),
            label: entry.itemLabel.value,
            arLabel: entry.itemLabelAr?.value || '',
            link: entry.item.value
          });
          feature.setStyle(new Style({
            image: new Icon({
              src: 'https://upload.wikimedia.org/wikipedia/commons/e/ec/RedDot.svg',
              scale: 0.1 // تم رفع الحجم
            })
          }));
          vectorSource.addFeature(feature);
        }
      } catch (error) {
        console.error("خطأ في جلب بيانات المواقع الأثرية:", error);
      }
    }

    loadArchaeologicalSites();
  </script>
</body>
</html>
