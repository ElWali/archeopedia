<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>LeafletXplorer v2.3</title>

  <!-- Leaflet Core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Plugins -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen@2.2.0/Control.FullScreen.css"/>
  <script src="https://unpkg.com/leaflet.fullscreen@2.2.0/Control.FullScreen.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.css"/>
  <script src="https://unpkg.com/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.js"></script>

  <script src="https://unpkg.com/leaflet-routing-machine@3.2.18/dist/leaflet-routing-machine.min.js"></script>
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet-minimap@3.6.0/dist/Control.MiniMap.min.css"/>
  <script src="https://unpkg.com/leaflet-minimap@3.6.0/dist/Control.MiniMap.min.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet-easybutton@2.4.0/src/easy-button.css"/>
  <script src="https://unpkg.com/leaflet-easybutton@2.4.0/src/easy-button.js"></script>

  <script src="https://unpkg.com/leaflet-geometryutil@0.10.2/src/leaflet.geometryutil.js"></script>

  <style>
    html,body,#map{height:100%;margin:0;padding:0;font-family:sans-serif}
    .info-box{background:#fff;padding:6px 8px;border-radius:6px;box-shadow:0 0 12px rgba(0,0,0,0.2);font-size:13px;max-width:300px;}
    .leaflet-control-attribution{font-size:11px;}
    .leaflet-routing-container{display:none;}
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    // Init
    const last = JSON.parse(localStorage.getItem('leafletXplorerView')) || {lat: 28.012, lng: -15.937, zoom: 6};
    const map = L.map('map', {zoomControl: false}).setView([last.lat, last.lng], last.zoom);
    L.control.zoom({position: 'topright'}).addTo(map);

    // Base Layers
    const baseLayers = {
      OSM: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19, attribution: '© OSM'}),
      Topo: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {maxZoom: 17, attribution: '© OpenTopoMap'}),
      Esri: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {maxZoom: 19, attribution: 'Esri'})
    };
    const lastLayer = localStorage.getItem('leafletXplorerLayer') || 'OSM';
    baseLayers[lastLayer].addTo(map);

    // Controls
    L.control.scale().addTo(map);
    map.addControl(new L.Control.Fullscreen({position: 'topright'}));
    new L.Control.MiniMap(baseLayers.OSM, {toggleDisplay: true, minimized: false}).addTo(map);
    L.easyButton('fa-location-arrow', () => map.locate({setView: true, maxZoom: 16}), 'Locate').addTo(map);

    // Data Layers
    const markers = L.markerClusterGroup();
    const markerData = [['Rabat',34.020882,-6.84165],['Casablanca',33.57311,-7.589843],['Laayoune',27.175015,-13.189543],['Dakhla',23.685,-15.942]];
    markerData.forEach(p => markers.addLayer(L.marker([p[1], p[2]]).bindPopup(`<b>${p[0]}</b>`)));
    markers.addTo(map);

    const heat = L.heatLayer(markers.getLayers().map((m,i) => [
      m.getLatLng().lat, m.getLatLng().lng, [0.6,0.8,0.7,0.9][i % 4]
    ]), {radius: 25, blur: 15, maxZoom: 17});

    const regions = L.geoJSON({
      type: 'FeatureCollection',
      features: [
        {type:'Feature',properties:{name:'North Coast',value:15},geometry:{type:'Polygon',coordinates:[[[-9,36],[-6,36],[-6,33],[-9,33],[-9,36]]]}},
        {type:'Feature',properties:{name:'Central Plateau',value:25},geometry:{type:'Polygon',coordinates:[[[-8,33],[-5,33],[-5,30],[-8,30],[-8,33]]]}},
        {type:'Feature',properties:{name:'Southern Desert',value:35},geometry:{type:'Polygon',coordinates:[[[-14,28],[-8,28],[-8,24],[-14,24],[-14,28]]]}}
      ]
    }, {
      style: f => ({
        fillColor: f.properties.value > 30 ? '#e31a1c' : f.properties.value > 20 ? '#fd8d3c' : '#feb24c',
        weight: 2, opacity: 1, color: 'white', dashArray: '3', fillOpacity: 0.7
      }),
      onEachFeature: (f,l) => l.bindPopup(`${f.properties.name}: ${f.properties.value}`)
    });

    // Draw & Measure
    const drawn = new L.FeatureGroup().addTo(map);
    map.addControl(new L.Control.Draw({edit: {featureGroup: drawn}}));

    const format = (v, u) => v > 1000 ? `${(v/1000).toFixed(2)} k${u}` : `${Math.round(v)} ${u}`;
    const measure = layer => {
      let c = 'No measurement';
      if (layer instanceof L.Polyline && !(layer instanceof L.Polygon)) {
        const len = L.GeometryUtil.length(layer);
        c = `Length: ${format(len, 'm')}`;
      } else if (layer instanceof L.Polygon || layer instanceof L.Rectangle) {
        const area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
        c = `Area: ${format(area, 'm²')}`;
      } else if (layer instanceof L.Circle) {
        const r = layer.getRadius(), a = Math.PI * r * r;
        c = `Area: ${format(a, 'm²')}<br>Radius: ${format(r, 'm')}`;
      }
      layer.getPopup() ? layer.setPopupContent(c) : layer.bindPopup(c);
    };

    map.on(L.Draw.Event.CREATED, e => { drawn.addLayer(e.layer); measure(e.layer); save(); });
    map.on(L.Draw.Event.EDITED, e => { e.layers.eachLayer(measure); save(); });
    map.on(L.Draw.Event.DELETED, save);

    const save = () => localStorage.setItem('leafletXplorerDraw', JSON.stringify(drawn.toGeoJSON()));
    const saved = localStorage.getItem('leafletXplorerDraw');
    if (saved) L.geoJSON(JSON.parse(saved), { onEachFeature: (f,l) => { drawn.addLayer(l); measure(l); }});

    // Import / Export
    L.easyButton('fa-upload', () => file.click(), 'Import GeoJSON').addTo(map);
    L.easyButton('fa-download', () => {
      const blob = new Blob([JSON.stringify(drawn.toGeoJSON())], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'map-data.geojson';
      a.click();
      URL.revokeObjectURL(a.href);
    }, 'Export GeoJSON').addTo(map);

    const file = document.createElement('input');
    file.type = 'file'; file.accept = '.geojson,.json'; file.style.display = 'none';
    document.body.appendChild(file);
    file.onchange = e => {
      const f = e.target.files[0];
      if (f) {
        const r = new FileReader();
        r.onload = ev => {
          try {
            const g = JSON.parse(ev.target.result);
            L.geoJSON(g, {
              style: {color:'#3388ff', weight:2, fillOpacity:0.3},
              onEachFeature: (feat, lyr) => { drawn.addLayer(lyr); measure(lyr); }
            });
            save(); map.fitBounds(drawn.getBounds());
          } catch (err) { alert('Invalid GeoJSON'); console.error(err); }
        };
        r.readAsText(f);
      }
    };

    // Routing & Geocoding
    const routing = L.Routing.control({
      router: L.Routing.osrmv1({serviceUrl: 'https://router.project-osrm.org/route/v1'}),
      waypoints: [], routeWhileDragging: true, addWaypoints: false, show: false
    }).addTo(map);

    L.easyButton('fa-road', () => {
      const el = document.querySelector('.leaflet-routing-container');
      el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }, 'Toggle Routing').addTo(map);

    L.Control.geocoder({
      defaultMarkGeocode: false,
      geocoder: L.Control.Geocoder.photon() // More reliable than Nominatim
    }).on('markgeocode', e => {
      map.fitBounds(e.geocode.bbox);
      L.marker(e.geocode.center).addTo(map).bindPopup(e.geocode.name).openPopup();
    }).addTo(map);

    // Info Box
    const info = L.control({position: 'bottomleft'});
    info.onAdd = () => { info._div = L.DomUtil.create('div', 'info-box'); info.update(); return info._div; };
    info.update = () => {
      const c = map.getCenter();
      info._div.innerHTML = `<b>LeafletXplorer v2.3</b><br>
        Lat: ${c.lat.toFixed(4)}, Lng: ${c.lng.toFixed(4)}, Zoom: ${map.getZoom()}<br>
        <small>f=fullscreen, h=heat, r=routing, ?=help</small>`;
    };
    info.addTo(map);

    // Events
    map.on('locationfound', e => L.marker(e.latlng).addTo(map).bindPopup(`~${Math.round(e.accuracy/2)}m`).openPopup());
    map.on('moveend', () => {
      localStorage.setItem('leafletXplorerView', JSON.stringify({lat: map.getCenter().lat, lng: map.getCenter().lng, zoom: map.getZoom()}));
      info.update();
    });
    map.on('baselayerchange', e => localStorage.setItem('leafletXplorerLayer', e.name));

    map.on('click', e => {
      const coords = `${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`;
      let content = `<b>${coords}</b>`;
      const popup = L.popup().setLatLng(e.latlng).setContent('Loading...').openOn(map);
      L.Control.Geocoder.photon().reverse(e.latlng, map.options.crs.scale(map.getZoom()), r => {
        if (r && r.length) content += `<br><small>${r[0].name}</small>`;
        popup.setContent(content + '<br><small>(copied)</small>');
      });
      navigator.clipboard.writeText(coords);
    });

    // Overlays & Persistence
    const overlays = {
      "Clusters": markers,
      "Heatmap": heat,
      "Choropleth": regions,
      "My Drawings": drawn
    };

    const loadOverlays = () => {
      const saved = JSON.parse(localStorage.getItem('leafletXplorerOverlays') || '{}');
      Object.keys(overlays).forEach(k => {
        if (saved[k] && !map.hasLayer(overlays[k])) map.addLayer(overlays[k]);
        if (!saved[k] && map.hasLayer(overlays[k])) map.removeLayer(overlays[k]);
      });
    };

    const saveOverlays = () => {
      const state = {};
      Object.keys(overlays).forEach(k => state[k] = map.hasLayer(overlays[k]));
      localStorage.setItem('leafletXplorerOverlays', JSON.stringify(state));
    };

    loadOverlays();
    L.control.layers(baseLayers, overlays, {collapsed: false}).addTo(map);
    map.on('overlayadd overlayremove', saveOverlays);

    // Keyboard shortcuts
    document.addEventListener('keydown', e => {
      if (['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) return;
      if (e.key === 'f') map.toggleFullscreen();
      if (e.key === 'h') map.hasLayer(heat) ? map.removeLayer(heat) : heat.addTo(map);
      if (e.key === 'r') {
        const el = document.querySelector('.leaflet-routing-container');
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
      }
      if (e.key === '?') alert("LeafletXplorer v2.3 Help:\n- f = fullscreen\n- h = toggle heatmap\n- r = toggle routing\n- Draw to save locally\n- Click map to copy coords");
    });

    window.Xplorer = map;
  </script>
</body>
</html>
