<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Archeopedia - Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø£Ø«Ø±ÙŠØ© Ø§Ù„Ù…ØºØ±Ø¨ÙŠØ©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body, html {
      height: 100%;
      margin: 0;
      direction: rtl;
      font-family: 'Cairo', 'Roboto', Arial, sans-serif;
      background: #e5e5e5;
      color: #222;
    }
    #map {
      width: 100vw;
      height: 100vh;
      z-index: 1;
    }
    #searchBar {
      position: absolute;
      top: 20px; left: 50%; transform: translateX(-50%);
      background: #fff;
      padding: 10px 20px;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.11);
      z-index: 9999;
      width: 320px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    #searchInput {
      flex: 1;
      border: 1px solid #bbb;
      border-radius: 8px;
      padding: 6px;
      font-size: 1em;
    }
    #openListBtn {
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 6px 14px;
      font-size: 1em;
      cursor: pointer;
    }
    #siteListModal {
      display: none;
      position: fixed;
      top: 0; right: 0;
      width: 350px; height: 100vh;
      background: #fff;
      overflow-y: auto;
      z-index: 99999;
      box-shadow: -2px 0 8px #aaa;
      padding: 18px 12px;
    }
    #siteListModal h2 {
      margin-top: 0;
      font-size: 1.3em;
    }
    #siteSearchInput {
      width: 95%;
      margin: 8px 0;
      padding: 6px;
      border-radius: 8px;
      border: 1px solid #bbb;
      font-size: 1em;
      display: block;
    }
    #siteList {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #siteList li {
      padding: 8px 0;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background 0.1s;
    }
    #siteList li:hover {
      background: #f3f3f3;
    }
    #closeListBtn {
      background: #dc3545;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 6px 14px;
      font-size: 1em;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
    }
    .leaflet-popup-content {
      min-width: 250px;
      font-size: 1.05em;
    }
    .popup-img {
      max-width: 100%;
      border-radius: 8px;
      margin: 8px 0;
      display: block;
    }
    .popup-desc {
      margin: 8px 0;
      color: #333;
    }
    .popup-links {
      margin-top: 6px;
      font-size: 0.95em;
    }
    #loading {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255,255,255,0.95);
      padding: 10px 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      z-index: 99998;
      font-size: 1.15em;
      display: none;
    }
    @media (max-width: 600px) {
      #siteListModal { width: 100vw; }
      #searchBar { width: 96vw; left: 2vw; transform: none;}
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="loading">ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø£Ø«Ø±ÙŠØ©...</div>
  <div id="searchBar">
    <input type="text" id="searchInput" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø®Ø±ÙŠØ·Ø©...">
    <button id="openListBtn">ğŸ“‹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</button>
  </div>
  <div id="siteListModal">
    <h2>ğŸ“‹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø£Ø«Ø±ÙŠØ©</h2>
    <input type="text" id="siteSearchInput" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆÙ‚Ø¹...">
    <ul id="siteList"></ul>
    <button id="closeListBtn">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
  <footer style="position:fixed;bottom:0;left:0;width:100vw;background:#fafafa;padding:6px 0;text-align:center;font-size:0.95em;z-index:999;">
    Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† ÙˆÙŠÙƒÙŠ Ø¨ÙŠØ§Ù†Ø§Øª | Ø®Ø±ÙŠØ·Ø©: Leaflet & OpenStreetMap
  </footer>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // --- Ø®Ø±ÙŠØ·Ø© ---
    const map = L.map('map').setView([33.97, -6.84], 6); // Ø§Ù„Ù…ØºØ±Ø¨

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // --- Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ ---
    let archeoSites = []; // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† ÙˆÙŠÙƒÙŠ Ø¨ÙŠØ§Ù†Ø§Øª
    let markers = []; // ÙƒÙ„ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª
    let results = []; // Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…
    let wikidataFetched = {}; // ÙƒØ§Ø´ Ù„Ø¬Ù„Ø¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„
    let lastQuery = '';

    // --- Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø£Ø«Ø±ÙŠØ© Ù…Ù† ÙˆÙŠÙƒÙŠ Ø¨ÙŠØ§Ù†Ø§Øª ---
    document.getElementById('loading').style.display = 'block';
    fetchSitesFromWikidata();

    function fetchSitesFromWikidata() {
      // SPARQL Ù„Ø¬Ù„Ø¨ Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…ØºØ±Ø¨ ÙÙ‚Ø· (ÙŠÙ…ÙƒÙ†Ùƒ ØªÙˆØ³ÙŠØ¹Ù‡)
      const endpoint = "https://query.wikidata.org/sparql";
      const sparql = `
        SELECT ?site ?siteLabel ?coord WHERE {
          ?site wdt:P31/wdt:P279* wd:Q839954 ; # instance of archaeological site
                wdt:P625 ?coord ;
                wdt:P17 wd:Q1028. # Ø§Ù„Ù…ØºØ±Ø¨
          SERVICE wikibase:label { bd:serviceParam wikibase:language "ar,en". }
        }
        LIMIT 120
      `;
      fetch(endpoint + "?query=" + encodeURIComponent(sparql), {
        headers: { 'Accept': 'application/sparql-results+json' }
      })
      .then(r => r.json())
      .then(data => {
        results = data.results.bindings;
        if (!results.length) {
          alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ÙˆØ§Ù‚Ø¹ Ø£Ø«Ø±ÙŠØ©!');
        }
        archeoSites = results.map(item => {
          let match = item.coord.value.match(/Point\(([-\d\.]+) ([-\d\.]+)\)/);
          return {
            siteLabel: item.siteLabel.value,
            wikidataUrl: item.site.value,
            lat: match ? parseFloat(match[2]) : null,
            lng: match ? parseFloat(match[1]) : null
          }
        }).filter(s=>s.lat && s.lng && s.siteLabel && s.wikidataUrl);
        addMarkers(archeoSites);
        setupSearchBar();
        setupSiteListModal();
        document.getElementById('loading').style.display = 'none';
      })
      .catch(err => {
        document.getElementById('loading').style.display = 'none';
        alert('ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† ÙˆÙŠÙƒÙŠ Ø¨ÙŠØ§Ù†Ø§Øª');
        console.error('ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† ÙˆÙŠÙƒÙŠ Ø¨ÙŠØ§Ù†Ø§Øª', err);
      });
    }

    // --- Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ù„Ù„Ø®Ø±ÙŠØ·Ø© ---
    function addMarkers(sites) {
      // Ø¥Ø²Ø§Ù„Ø© Ø¹Ù„Ø§Ù…Ø§Øª Ø³Ø§Ø¨Ù‚Ø©
      markers.forEach(m => map.removeLayer(m));
      markers = [];
      sites.forEach(site => {
        const marker = L.marker([site.lat, site.lng])
          .addTo(map)
          .on('click', function() {
            showWikidataPopup(site);
          });
        markers.push(marker);
      });
    }

    // --- Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ø¨Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙˆÙŠÙƒÙŠØ¯Ø§ØªØ§ ---
    function showWikidataPopup(site) {
      // Ø¬Ù„Ø¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù…Ù† Ø§Ù„ÙƒØ§Ø´ Ø£Ùˆ Ù…Ù† ÙˆÙŠÙƒÙŠØ¯Ø§ØªØ§
      const id = site.wikidataUrl.split('/').pop();
      if (wikidataFetched[id]) {
        renderPopup(site, wikidataFetched[id]);
        return;
      }
      // Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ø¤Ù‚ØªØ©
      L.popup()
        .setLatLng([site.lat, site.lng])
        .setContent(`<div>Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹...</div>`)
        .openOn(map);

      fetch(`https://www.wikidata.org/wiki/Special:EntityData/${id}.json`)
        .then(r => r.json())
        .then(data => {
          const entity = data.entities[id];
          // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª
          const label = entity.labels?.ar?.value || entity.labels?.en?.value || site.siteLabel;
          const description = entity.descriptions?.ar?.value || entity.descriptions?.en?.value || '';
          // ØµÙˆØ±Ø© Ø±Ø¦ÙŠØ³ÙŠØ©
          const imageClaim = entity.claims?.P18?.[0]?.mainsnak?.datavalue?.value;
          const imageUrl = imageClaim ? `https://commons.wikimedia.org/wiki/Special:FilePath/${encodeURIComponent(imageClaim)}?width=350` : '';
          // Ø±ÙˆØ§Ø¨Ø· Ø®Ø§Ø±Ø¬ÙŠØ©
          let moreLinks = `<a href="${site.wikidataUrl}" target="_blank">ÙˆÙŠÙƒÙŠØ¯Ø§ØªØ§</a>`;
          // ÙˆÙŠÙƒÙŠØ¨ÙŠØ¯ÙŠØ§
          if (entity.sitelinks?.arwiki?.url)
            moreLinks += ` | <a href="${entity.sitelinks.arwiki.url}" target="_blank">ÙˆÙŠÙƒÙŠØ¨ÙŠØ¯ÙŠØ§</a>`;
          else if (entity.sitelinks?.enwiki?.url)
            moreLinks += ` | <a href="${entity.sitelinks.enwiki.url}" target="_blank">Wikipedia</a>`;
          // Ø­ÙØ¸ Ø¨Ø§Ù„ÙƒØ§Ø´
          wikidataFetched[id] = {label, description, imageUrl, moreLinks};
          renderPopup(site, wikidataFetched[id]);
        })
        .catch(() => {
          renderPopup(site, {
            label: site.siteLabel,
            description: '',
            imageUrl: '',
            moreLinks: `<a href="${site.wikidataUrl}" target="_blank">ÙˆÙŠÙƒÙŠØ¯Ø§ØªØ§</a>`
          });
        });
    }

    function renderPopup(site, details) {
      let html = `<strong>${details.label}</strong>`;
      if (details.imageUrl)
        html += `<br><img src="${details.imageUrl}" class="popup-img" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹">`;
      if (details.description)
        html += `<div class="popup-desc">${details.description}</div>`;
      html += `<div class="popup-links">${details.moreLinks}</div>`;
      L.popup()
        .setLatLng([site.lat, site.lng])
        .setContent(html)
        .openOn(map);
    }

    // --- Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ---
    function setupSearchBar() {
      const input = document.getElementById('searchInput');
      input.addEventListener('input', function(e) {
        const query = e.target.value.trim().toLowerCase();
        lastQuery = query;
        // ØªØµÙÙŠØ© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹
        let filtered = !query ? archeoSites : archeoSites.filter(site =>
          site.siteLabel.toLowerCase().includes(query)
        );
        addMarkers(filtered);
        if (filtered.length > 0 && query.length > 1) {
          map.setView([filtered[0].lat, filtered[0].lng], 8);
        }
      });
    }

    // --- Ù†Ø§ÙØ°Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ù…Ø¹ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ---
    function setupSiteListModal() {
      // ÙØªØ­ ÙˆØºÙ„Ù‚
      document.getElementById('openListBtn').onclick = function() {
        document.getElementById('siteListModal').style.display = 'block';
        updateSiteList('');
        document.getElementById('siteSearchInput').value = '';
      };
      document.getElementById('closeListBtn').onclick = function() {
        document.getElementById('siteListModal').style.display = 'none';
      };
      // Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
      document.getElementById('siteSearchInput').addEventListener('input', function(e) {
        updateSiteList(e.target.value);
      });
      updateSiteList('');
    }

    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
    function updateSiteList(query) {
      const list = document.getElementById('siteList');
      query = (query || '').trim().toLowerCase();
      const filtered = !query ? archeoSites : archeoSites.filter(site =>
        site.siteLabel.toLowerCase().includes(query)
      );
      list.innerHTML = '';
      filtered.forEach(site => {
        const li = document.createElement('li');
        li.textContent = site.siteLabel;
        li.onclick = () => {
          map.setView([site.lat, site.lng], 12);
          showWikidataPopup(site);
          document.getElementById('siteListModal').style.display = 'none';
        };
        list.appendChild(li);
      });
      if (!filtered.length) {
        list.innerHTML = `<li>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.</li>`;
      }
    }
  </script>
</body>
</html>
