<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>المنصة العلمية للتحليل الجغرافي المتكامل</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary: #1a73e8;
      --primary-dark: #1557b0;
      --secondary: #34a853;
      --accent: #fbbc05;
      --danger: #ea4335;
      --info: #4285f4;
      --warning: #f4b400;
      --success: #34a853;
      --light: #f8f9fa;
      --dark: #202124;
      --gray: #5f6368;
      --border: #dadce0;
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
      --shadow-lg: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
      --radius: 12px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-fast: all 0.15s ease-in-out;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      margin: 0;
      font-family: 'Cairo', 'Roboto', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      color: var(--dark);
      direction: rtl;
    }

    header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 1rem 2rem;
      font-size: 1.5em;
      font-weight: 600;
      box-shadow: var(--shadow-lg);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      z-index: 1000;
    }

    .header-content {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logo {
      font-size: 1.8rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .header-icons {
      display: flex;
      gap: 0.8rem;
    }

    .icon-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition-fast);
      font-size: 1.1rem;
    }

    .icon-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    .container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 64px);
    }

    .info-panel {
      background: white;
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
      color: var(--gray);
      text-align: center;
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .info-text {
      flex: 1;
      text-align: center;
    }

    .mode-toggle {
      background: var(--light);
      border: 1px solid var(--border);
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .mode-toggle:hover {
      background: #e8f0fe;
      border-color: var(--primary);
    }

    #map {
      flex: 1;
      width: 100%;
    }

    .leaflet-container {
      background: #e9ecef;
    }

    .leaflet-popup-content-wrapper {
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      overflow: hidden;
    }

    .popup-container {
      min-width: 450px;
      max-width: 600px;
      font-family: 'Cairo', sans-serif;
    }

    .popup-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 1.2rem 1.5rem;
      border-radius: calc(var(--radius) - 1px) calc(var(--radius) - 1px) 0 0;
      margin: -1px -1px 0 -1px;
    }

    .popup-title {
      font-size: 1.3rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .popup-subtitle {
      font-size: 0.9rem;
      opacity: 0.9;
      margin-top: 0.3rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .popup-body {
      padding: 1.5rem;
      max-height: 700px;
      overflow-y: auto;
    }

    .data-section {
      margin-bottom: 1.5rem;
      padding-bottom: 1.2rem;
      border-bottom: 1px solid var(--border);
    }

    .data-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .section-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .data-item {
      margin-bottom: 0.8rem;
      padding: 0.8rem;
      background: var(--light);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      transition: var(--transition-fast);
      position: relative;
    }

    .data-item:hover {
      background: #f1f3f4;
      border-color: var(--primary);
      transform: translateX(6px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .data-label {
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 0.3rem;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .data-value {
      color: var(--gray);
      font-size: 0.95rem;
      line-height: 1.5;
      padding-right: 1.5rem;
    }

    .data-value b {
      color: var(--dark);
      font-weight: 600;
    }

    .tags-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 0.6rem;
      margin-top: 0.6rem;
    }

    .tag-item {
      background: #e8f0fe;
      color: var(--primary);
      padding: 0.5rem 0.7rem;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 500;
      text-align: center;
      border: 1px solid #d2e3fc;
      transition: var(--transition-fast);
    }

    .tag-item:hover {
      background: var(--primary);
      color: white;
      transform: translateY(-1px);
    }

    .coordinates {
      display: flex;
      gap: 1.2rem;
      margin-bottom: 0.8rem;
    }

    .coord-item {
      flex: 1;
      background: #f8f9fa;
      padding: 0.5rem;
      border-radius: 6px;
      font-size: 0.95rem;
      text-align: center;
      border: 1px solid var(--border);
      font-family: monospace;
    }

    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 3rem 2rem;
      color: var(--gray);
      text-align: center;
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      color: var(--danger);
      font-weight: 500;
      text-align: center;
      padding: 1.5rem;
      line-height: 1.6;
    }

    .feature-count {
      font-size: 0.85rem;
      color: var(--gray);
      margin-top: 0.6rem;
      text-align: center;
    }

    .popup-footer {
      text-align: center;
      padding: 1rem 1.5rem;
      background: var(--light);
      border-top: 1px solid var(--border);
      border-radius: 0 0 calc(var(--radius) - 1px) calc(var(--radius) - 1px);
      font-size: 0.85rem;
      color: var(--gray);
      display: flex;
      justify-content: space-between;
    }

    .action-buttons {
      display: flex;
      gap: 0.8rem;
      margin-top: 0.5rem;
    }

    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: var(--transition-fast);
      font-weight: 500;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .btn-outline {
      background: transparent;
      color: var(--primary);
      border: 1px solid var(--primary);
    }

    .btn-outline:hover {
      background: rgba(26, 115, 232, 0.1);
    }

    .chart-container {
      position: relative;
      height: 250px;
      margin: 1rem 0;
      border-radius: var(--radius);
      overflow: hidden;
      background: white;
      padding: 1rem;
      border: 1px solid var(--border);
    }

    .scientific-tools {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .tool-card {
      background: white;
      padding: 1rem;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      transition: var(--transition-fast);
    }

    .tool-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .tool-title {
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .tool-value {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--dark);
    }

    .tool-unit {
      font-size: 0.8rem;
      color: var(--gray);
      margin-dir: 0.3rem;
    }

    .tool-desc {
      font-size: 0.85rem;
      color: var(--gray);
      margin-top: 0.5rem;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      font-size: 0.85rem;
    }

    .data-table th {
      text-align: right;
      padding: 0.6rem;
      background: #f1f3f4;
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      color: var(--dark);
    }

    .data-table td {
      padding: 0.6rem;
      border-bottom: 1px solid var(--border);
      color: var(--gray);
    }

    .data-table tr:last-child td {
      border-bottom: none;
    }

    .data-table tr:hover td {
      background: #f8f9fa;
    }

    .legend {
      display: flex;
      gap: 1rem;
      margin-top: 0.5rem;
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.8rem;
      color: var(--gray);
    }

    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .map-marker {
      background: white;
      width: 34px;
      height: 34px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      border: 2px solid var(--primary);
      position: relative;
    }

    .map-marker::after {
      content: '';
      width: 14px;
      height: 14px;
      background: var(--primary);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.7; }
      100% { transform: scale(1); opacity: 1; }
    }

    .scientific-badge {
      background: var(--info);
      color: white;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
      margin-dir: 0.5rem;
    }

    .export-panel {
      margin-top: 1rem;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    .export-title {
      font-weight: 600;
      margin-bottom: 0.8rem;
      color: var(--dark);
    }

    .export-options {
      display: flex;
      gap: 0.8rem;
      flex-wrap: wrap;
    }

    .export-btn {
      padding: 0.4rem 0.8rem;
      background: white;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: var(--transition-fast);
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .export-btn:hover {
      background: #e8f0fe;
      border-color: var(--primary);
      color: var(--primary);
    }

    @media (max-width: 768px) {
      header {
        padding: 1rem;
        flex-direction: column;
        gap: 0.5rem;
        text-align: center;
      }
      
      .logo {
        font-size: 1.5rem;
      }
      
      .popup-container {
        min-width: 320px;
        max-width: 100%;
      }
      
      .popup-body {
        padding: 1rem;
      }
      
      .coordinates {
        flex-direction: column;
      }
      
      .tags-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .scientific-tools {
        grid-template-columns: 1fr;
      }
      
      .chart-container {
        height: 200px;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="logo">🔬 منصة التحليل الجغرافي العلمية</div>
      <div>تحليل متقدم للبيانات المكانية باستخدام تقنيات الذكاء الاصطناعي</div>
    </div>
    <div class="header-icons">
      <button class="icon-btn" title="إعادة التمركز"><i>⟳</i></button>
      <button class="icon-btn" title="الوضع العلمي"><i>📊</i></button>
      <button class="icon-btn" title="مشاركة"><i>↗</i></button>
    </div>
  </header>

  <div class="container">
    <div class="info-panel">
      <div class="info-text">انقر على أي نقطة في الخريطة لتحليل البيانات الجغرافية المتقدمة باستخدام تقنيات الذكاء الاصطناعي</div>
      <div class="mode-toggle">الوضع العادي</div>
    </div>
    <div id="map"></div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // تهيئة الخريطة
    const map = L.map('map', {
      zoomControl: false,
      attributionControl: false
    }).setView([31.7917, -7.0926], 6); // المغرب

    // إضافة تحكم بالتكبير
    L.control.zoom({
      position: 'bottomright'
    }).addTo(map);

    // إضافة طبقة الخريطة
    const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> المساهمون',
      maxZoom: 19
    }).addTo(map);

    // إضافة طبقة صور الأقمار الصناعية
    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles © <a href="https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer">ArcGIS</a>',
      maxZoom: 19
    });

    // إضافة طبقة التضاريس
    const terrainLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
      attribution: 'Map © <a href="https://opentopomap.org/">OpenTopoMap</a> contributors',
      maxZoom: 17
    });

    // تحكم في الطبقات
    const baseLayers = {
      "الخريطة الأساسية": osmLayer,
      "الصور الجوية": satelliteLayer,
      "التضاريس والارتفاعات": terrainLayer
    };

    L.control.layers(baseLayers, null, {
      position: 'topright'
    }).addTo(map);

    // إضافة عنصر تحكم بالمقياس
    L.control.scale({
      position: 'bottomleft',
      metric: true,
      imperial: false
    }).addTo(map);

    // متغيرات التحكم في الوضع
    let scientificMode = false;
    let lastMarker = null;
    let charts = {};

    // دالة لتحليل البيانات البيئية بناءً على الارتفاع
    function analyzeEnvironmentalConditions(elevation, lat, lng) {
      const conditions = {
        climate: '',
        vegetation: '',
        water: '',
        soil: '',
        hazards: []
      };

      // تحليل المناخ حسب الارتفاع وخط العرض
      if (elevation < 100) {
        if (lat > 30) {
          conditions.climate = 'مناخ متوسط ساحلي';
        } else {
          conditions.climate = 'مناخ استوائي ساحلي';
        }
      } else if (elevation < 500) {
        conditions.climate = 'مناخ معتدل';
      } else if (elevation < 1500) {
        conditions.climate = 'مناخ بارد معتدل';
      } else {
        conditions.climate = 'مناخ جبلي بارد';
      }

      // تحليل الغطاء النباتي
      if (elevation < 200) {
        conditions.vegetation = 'أراضي زراعية وسهول';
      } else if (elevation < 800) {
        conditions.vegetation = 'غابات معتدلة';
      } else if (elevation < 1500) {
        conditions.vegetation = 'غابات جبلية';
      } else {
        conditions.vegetation = 'أراضي صخرية وثلوج دائمة';
      }

      // تحليل الموارد المائية
      if (elevation > 1000) {
        conditions.water = 'مصدر رئيسي للمياه الجوفية';
      } else if (elevation > 500) {
        conditions.water = 'جداول جبلية موسمية';
      } else {
        conditions.water = 'مصادر مائية سطحية';
      }

      // تحليل التربة
      if (elevation < 300) {
        conditions.soil = 'تربة خصبة مناسبة للزراعة';
      } else if (elevation < 800) {
        conditions.soil = 'تربة متوسطة الخصوبة';
      } else {
        conditions.soil = 'تربة صخرية ضعيفة الخصوبة';
      }

      // تحديد المخاطر المحتملة
      if (elevation > 1500 && lat > 30) {
        conditions.hazards.push('انزلاقات ثلجية');
      }
      if (elevation < 50 && lng < 0) {
        conditions.hazards.push('فيضانات ساحلية');
      }
      if (elevation > 1000) {
        conditions.hazards.push('صعوبة الوصول');
      }

      return conditions;
    }

    // دالة حساب المسافة من البحر
    function calculateDistanceToCoast(lat, lng) {
      // هذه الإحداثيات تمثل بعض النقاط الساحلية الرئيسية في المغرب
      const coastPoints = [
        [35.7744, -3.8657], // طنجة
        [34.0388, -6.8199], // الدار البيضاء
        [32.2983, -9.2333], // أكادير
        [27.9861, -15.6894] // العيون
      ];

      let minDistance = Infinity;
      
      coastPoints.forEach(point => {
        const R = 6371; // نصف قطر الأرض بالكيلومتر
        const dLat = (point[0] - lat) * Math.PI / 180;
        const dLon = (point[1] - lng) * Math.PI / 180;
        const a = 
          Math.sin(dLat/2) * Math.sin(dLat/2) +
          Math.cos(lat * Math.PI / 180) * Math.cos(point[0] * Math.PI / 180) * 
          Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        const distance = R * c;
        
        if (distance < minDistance) {
          minDistance = distance;
        }
      });

      return minDistance;
    }

    // دالة تحليل الاستخدامات الأرضية
    function analyzeLandUse(tagsData) {
      const analysis = {
        urban: 0,
        agricultural: 0,
        natural: 0,
        industrial: 0,
        recreational: 0
      };

      const urbanTags = ['building', 'residential', 'apartments', 'house', 'housenumber'];
      const agriculturalTags = ['farmland', 'farm', 'orchard', 'vineyard', 'meadow'];
      const naturalTags = ['forest', 'wood', 'natural', 'scrub', 'heath'];
      const industrialTags = ['industrial', 'factory', 'warehouse', 'plant'];
      const recreationalTags = ['park', 'playground', 'recreation_ground', 'pitch'];

      tagsData.forEach(element => {
        if (element.tags) {
          Object.keys(element.tags).forEach(key => {
            if (urbanTags.includes(key) || urbanTags.some(tag => element.tags[key].includes(tag))) {
              analysis.urban++;
            }
            if (agriculturalTags.includes(key) || agriculturalTags.some(tag => element.tags[key].includes(tag))) {
              analysis.agricultural++;
            }
            if (naturalTags.includes(key) || naturalTags.some(tag => element.tags[key].includes(tag))) {
              analysis.natural++;
            }
            if (industrialTags.includes(key) || industrialTags.some(tag => element.tags[key].includes(tag))) {
              analysis.industrial++;
            }
            if (recreationalTags.includes(key) || recreationalTags.some(tag => element.tags[key].includes(tag))) {
              analysis.recreational++;
            }
          });
        }
      });

      // حساب النسب المئوية
      const total = Object.values(analysis).reduce((a, b) => a + b, 0);
      if (total > 0) {
        Object.keys(analysis).forEach(key => {
          analysis[key] = Math.round((analysis[key] / total) * 100);
        });
      }

      return analysis;
    }

    // دالة إنشاء مخطط دائري
    function createPieChart(ctx, data, labels, title) {
      if (charts[ctx.canvas.id]) {
        charts[ctx.canvas.id].destroy();
      }

      charts[ctx.canvas.id] = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: [
              '#1a73e8',
              '#34a853',
              '#fbbc05',
              '#ea4335',
              '#4285f4'
            ],
            borderWidth: 2,
            borderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 20,
                usePointStyle: true
              }
            },
            title: {
              display: true,
              text: title,
              font: {
                size: 14,
                weight: 'bold'
              }
            }
          }
        }
      });
    }

    // دالة إنشاء مخطط شريطي
    function createBarChart(ctx, data, labels, title) {
      if (charts[ctx.canvas.id]) {
        charts[ctx.canvas.id].destroy();
      }

      charts[ctx.canvas.id] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'الكثافة',
            data: data,
            backgroundColor: 'rgba(26, 115, 232, 0.7)',
            borderColor: 'rgba(26, 115, 232, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            title: {
              display: true,
              text: title,
              font: {
                size: 14,
                weight: 'bold'
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });
    }

    // دالة توليد تقرير علمي
    function generateScientificReport(data) {
      const report = {
        siteClassification: '',
        developmentPotential: '',
        environmentalImpact: '',
        recommendations: []
      };

      // تصنيف الموقع
      if (data.elevation < 100 && data.distanceToCoast < 50) {
        report.siteClassification = 'منطقة ساحلية منخفضة';
      } else if (data.elevation > 1000) {
        report.siteClassification = 'منطقة جبلية عالية';
      } else if (data.landUse.urban > 50) {
        report.siteClassification = 'منطقة حضرية متطورة';
      } else {
        report.siteClassification = 'منطقة ريفية';
      }

      // إمكانات التنمية
      if (data.landUse.urban > 70) {
        report.developmentPotential = 'عالية جداً';
      } else if (data.landUse.urban > 40) {
        report.developmentPotential = 'متوسطة';
      } else {
        report.developmentPotential = 'منخفضة';
      }

      // التأثير البيئي
      if (data.elevation > 1500 || data.distanceToCoast < 5) {
        report.environmentalImpact = 'حساس بيئياً';
      } else {
        report.environmentalImpact = 'متوسط الحساسية';
      }

      // التوصيات
      if (data.elevation < 100 && data.landUse.agricultural > 30) {
        report.recommendations.push('مناسبة للزراعة المروية');
      }
      if (data.elevation > 1000 && data.conditions.hazards.length === 0) {
        report.recommendations.push('مناسبة للسياحة الجبلية');
      }
      if (data.distanceToCoast < 10) {
        report.recommendations.push('إمكانية تطوير السياحة الساحلية');
      }
      if (data.landUse.industrial > 20) {
        report.recommendations.push('منطقة صناعية نشطة');
      }

      return report;
    }

    // دالة تصدير البيانات
    function exportData(data, format) {
      const filename = `تحليل_جغرافي_${Date.now()}`;
      
      switch(format) {
        case 'json':
          const jsonStr = JSON.stringify(data, null, 2);
          const blobJson = new Blob([jsonStr], {type: 'application/json'});
          const urlJson = URL.createObjectURL(blobJson);
          const aJson = document.createElement('a');
          aJson.href = urlJson;
          aJson.download = `${filename}.json`;
          aJson.click();
          break;
          
        case 'csv':
          let csv = 'البيانات,القيمة\n';
          Object.keys(data).forEach(key => {
            if (typeof data[key] === 'object') {
              csv += `${key},${JSON.stringify(data[key])}\n`;
            } else {
              csv += `${key},${data[key]}\n`;
            }
          });
          const blobCsv = new Blob([csv], {type: 'text/csv'});
          const urlCsv = URL.createObjectURL(blobCsv);
          const aCsv = document.createElement('a');
          aCsv.href = urlCsv;
          aCsv.download = `${filename}.csv`;
          aCsv.click();
          break;
          
        case 'pdf':
          alert('ميزة تصدير PDF متاحة في النسخة المدفوعة من المنصة');
          break;
      }
    }

    // وظيفة تحليل البيانات عند النقر
    map.on('click', async function (e) {
      const lat = e.latlng.lat.toFixed(6);
      const lng = e.latlng.lng.toFixed(6);
      const latNum = parseFloat(lat);
      const lngNum = parseFloat(lng);

      // إزالة العلامة القديمة إذا وجدت
      if (lastMarker) {
        map.removeLayer(lastMarker);
      }

      // إنشاء علامة جديدة
      lastMarker = L.marker(e.latlng, {
        icon: L.divIcon({
          className: 'map-marker',
          iconSize: [34, 34],
          iconAnchor: [17, 17]
        })
      }).addTo(map);

      // محتوى الفقاعة مع شاشة التحميل
      const popup = L.popup({
        minWidth: 500,
        maxWidth: 700,
        autoClose: false,
        closeOnClick: false
      })
        .setLatLng(e.latlng)
        .setContent(`
          <div class="popup-container">
            <div class="popup-header">
              <div class="popup-title">🔬 التحليل الجغرافي العلمي</div>
              <div class="popup-subtitle">تحليل متقدم باستخدام تقنيات الذكاء الاصطناعي</div>
            </div>
            <div class="popup-body">
              <div class="loading">
                <div class="loading-spinner"></div>
                <div>جاري تحليل البيانات الجغرافية المتقدمة باستخدام تقنيات الذكاء الاصطناعي...</div>
              </div>
            </div>
            <div class="popup-footer">
              <div>التحليل في الوقت الحقيقي</div>
              <div class="action-buttons">
                <button class="btn btn-outline" onclick="this.closest('.leaflet-popup').querySelector('.leaflet-popup-close-button').click()">إغلاق</button>
              </div>
            </div>
          </div>
        `)
        .openOn(map);

      try {
        // جمع البيانات من عدة مصادر
        const [nominatimData, elevationData, overpassData, timezoneData] = await Promise.all([
          // 1. Nominatim - معلومات العنوان
          fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&zoom=18&addressdetails=1&extratags=1&namedetails=1`)
            .then(res => res.json())
            .catch(() => null),

          // 2. Elevation - الارتفاع
          fetch(`https://api.open-elevation.com/api/v1/lookup?locations=${lat},${lng}`)
            .then(res => res.json())
            .catch(() => null),

          // 3. Overpass - بيانات OSM المفصلة
          fetch("https://overpass-api.de/api/interpreter", {
            method: "POST",
            body: `
              [out:json][timeout:25];
              (
                node(around:200,${lat},${lng});
                way(around:200,${lat},${lng});
                relation(around:200,${lat},${lng});
              );
              out center tags qt;
              >;
              out skel qt;
            `
          })
            .then(res => res.json())
            .catch(() => null),

          // 4. Timezone - المنطقة الزمنية
          fetch(`https://timeapi.io/api/Time/current/coordinate?latitude=${lat}&longitude=${lng}`)
            .then(res => res.json())
            .catch(() => null)
        ]);

        // تخزين البيانات للاستخدام لاحقاً
        const allData = {
          coordinates: { lat: latNum, lng: lngNum },
          timestamp: new Date().toISOString(),
          sources: {
            nominatim: nominatimData,
            elevation: elevationData,
            overpass: overpassData,
            timezone: timezoneData
          }
        };

        // معالجة البيانات وبناء المحتوى
        let popupContent = `
          <div class="popup-container">
            <div class="popup-header">
              <div class="popup-title">🔬 التحليل الجغرافي العلمي</div>
              <div class="popup-subtitle">تحليل متقدم باستخدام تقنيات الذكاء الاصطناعي</div>
            </div>
            <div class="popup-body">
        `;

        // 1. قسم الإحداثيات والبيانات الأساسية
        popupContent += `
          <div class="data-section">
            <div class="section-title">📍 الإحداثيات الجغرافية الأساسية</div>
            <div class="coordinates">
              <div class="coord-item">خط العرض: <b>${lat}</b></div>
              <div class="coord-item">خط الطول: <b>${lng}</b></div>
            </div>
        `;

        // استخراج الارتفاع
        let elevation = null;
        if (elevationData && elevationData.results && elevationData.results[0]) {
          elevation = elevationData.results[0].elevation;
          popupContent += `
            <div class="data-item">
              <div class="data-label">⛰️ الارتفاع عن سطح البحر</div>
              <div class="data-value"><b>${elevation.toFixed(2)} متر</b></div>
            </div>
          `;
        }

        // حساب المسافة من الساحل
        const distanceToCoast = calculateDistanceToCoast(latNum, lngNum);
        popupContent += `
          <div class="data-item">
            <div class="data-label">🌊 المسافة من الساحل</div>
            <div class="data-value"><b>${distanceToCoast.toFixed(2)} كم</b></div>
          </div>
        `;

        // إضافة المنطقة الزمنية
        if (timezoneData) {
          popupContent += `
            <div class="data-item">
              <div class="data-label">⏰ المنطقة الزمنية</div>
              <div class="data-value">
                <b>${timezoneData.timeZoneId || 'غير معروفة'}</b><br/>
                الوقت: ${timezoneData.time || 'غير متاح'}<br/>
                التاريخ: ${timezoneData.date || 'غير متاح'}
              </div>
            </div>
          `;
        }

        popupContent += `</div>`;

        // 2. تحليل الظروف البيئية
        const conditions = analyzeEnvironmentalConditions(elevation || 0, latNum, lngNum);
        popupContent += `
          <div class="data-section">
            <div class="section-title">🌿 التحليل البيئي</div>
            <div class="data-item">
              <div class="data-label">🌤️ المناخ</div>
              <div class="data-value"><b>${conditions.climate}</b></div>
            </div>
            <div class="data-item">
              <div class="data-label">🌳 الغطاء النباتي</div>
              <div class="data-value"><b>${conditions.vegetation}</b></div>
            </div>
            <div class="data-item">
              <div class="data-label">💧 الموارد المائية</div>
              <div class="data-value"><b>${conditions.water}</b></div>
            </div>
            <div class="data-item">
              <div class="data-label">🌱 نوع التربة</div>
              <div class="data-value"><b>${conditions.soil}</b></div>
            </div>
        `;

        if (conditions.hazards.length > 0) {
          popupContent += `
            <div class="data-item">
              <div class="data-label">⚠️ المخاطر البيئية</div>
              <div class="data-value">
                ${conditions.hazards.map(hazard => `• ${hazard}`).join('<br>')}
              </div>
            </div>
          `;
        }

        popupContent += `</div>`;

        // 3. تحليل استخدامات الأراضي
        if (overpassData && overpassData.elements && overpassData.elements.length > 0) {
          const landUse = analyzeLandUse(overpassData.elements);
          allData.landUse = landUse;
          allData.conditions = conditions;
          allData.distanceToCoast = distanceToCoast;

          popupContent += `
            <div class="data-section">
              <div class="section-title">🏗️ تحليل استخدامات الأراضي</div>
              <div class="chart-container">
                <canvas id="landUseChart"></canvas>
              </div>
          `;

          // إضافة جدول تفصيلي
          popupContent += `
            <div class="data-table">
              <table>
                <tr>
                  <th>نوع الاستخدام</th>
                  <th>النسبة المئوية</th>
                  <th>الوصف</th>
                </tr>
                <tr>
                  <td>منطقة حضرية</td>
                  <td>${landUse.urban}%</td>
                  <td>مباني وسكن وخدمات</td>
                </tr>
                <tr>
                  <td>منطقة زراعية</td>
                  <td>${landUse.agricultural}%</td>
                  <td>أراضي زراعية وحدائق</td>
                </tr>
                <tr>
                  <td>منطقة طبيعية</td>
                  <td>${landUse.natural}%</td>
                  <td>غابات وأشجار طبيعية</td>
                </tr>
                <tr>
                  <td>منطقة صناعية</td>
                  <td>${landUse.industrial}%</td>
                  <td>مصانع ومستودعات</td>
                </tr>
                <tr>
                  <td>منطقة ترفيهية</td>
                  <td>${landUse.recreational}%</td>
                  <td>حدائق ومساحات ترفيهية</td>
                </tr>
              </table>
            </div>
          `;

          popupContent += `</div>`;
        }

        // 4. تحليل البنية التحتية
        if (overpassData && overpassData.elements && overpassData.elements.length > 0) {
          const infrastructure = {
            transportation: {
              roads: 0,
              railways: 0,
              airports: 0
            },
            services: {
              healthcare: 0,
              education: 0,
              commercial: 0
            },
            utilities: {
              energy: 0,
              water: 0,
              communications: 0
            }
          };

          overpassData.elements.forEach(el => {
            if (el.tags) {
              // وسائل النقل
              if (el.tags.highway) infrastructure.transportation.roads++;
              if (el.tags.railway) infrastructure.transportation.railways++;
              if (el.tags.aeroway) infrastructure.transportation.airports++;
              
              // الخدمات
              if (el.tags.amenity === 'hospital' || el.tags.healthcare) infrastructure.services.healthcare++;
              if (el.tags.amenity === 'school' || el.tags.amenity === 'university') infrastructure.services.education++;
              if (el.tags.shop || el.tags.office) infrastructure.services.commercial++;
              
              // المرافق
              if (el.tags.power || el.tags.generator) infrastructure.utilities.energy++;
              if (el.tags.water || el.tags.potable) infrastructure.utilities.water++;
              if (el.tags.communication || el.tags.antenna) infrastructure.utilities.communications++;
            }
          });

          popupContent += `
            <div class="data-section">
              <div class="section-title">🛣️ تحليل البنية التحتية</div>
              <div class="scientific-tools">
                <div class="tool-card">
                  <div class="tool-title">🚗 النقل</div>
                  <div class="tool-value">${infrastructure.transportation.roads}</div>
                  <div class="tool-unit">طرق</div>
                  <div class="tool-desc">شبكة طرق محلية</div>
                </div>
                <div class="tool-card">
                  <div class="tool-title">🏥 الخدمات الصحية</div>
                  <div class="tool-value">${infrastructure.services.healthcare}</div>
                  <div class="tool-unit">مرافق</div>
                  <div class="tool-desc">مستشفيات وعيادات</div>
                </div>
                <div class="tool-card">
                  <div class="tool-title">🏫 التعليم</div>
                  <div class="tool-value">${infrastructure.services.education}</div>
                  <div class="tool-unit">مؤسسات</div>
                  <div class="tool-desc">مدارس وجامعات</div>
                </div>
                <div class="tool-card">
                  <div class="tool-title">⚡ الطاقة</div>
                  <div class="tool-value">${infrastructure.utilities.energy}</div>
                  <div class="tool-unit">مصادر</div>
                  <div class="tool-desc">محطات طاقة</div>
                </div>
              </div>
            </div>
          `;
        }

        // 5. التقرير العلمي والتوصيات
        const report = generateScientificReport(allData);
        popupContent += `
          <div class="data-section">
            <div class="section-title">📊 التقرير العلمي والتوصيات</div>
            <div class="data-item">
              <div class="data-label">📌 تصنيف الموقع</div>
              <div class="data-value"><b>${report.siteClassification}</b></div>
            </div>
            <div class="data-item">
              <div class="data-label">🚀 إمكانات التنمية</div>
              <div class="data-value"><b>${report.developmentPotential}</b></div>
            </div>
            <div class="data-item">
              <div class="data-label">🌍 الحساسية البيئية</div>
              <div class="data-value"><b>${report.environmentalImpact}</b></div>
            </div>
        `;

        if (report.recommendations.length > 0) {
          popupContent += `
            <div class="data-item">
              <div class="data-label">💡 التوصيات</div>
              <div class="data-value">
                ${report.recommendations.map(rec => `• ${rec}`).join('<br>')}
              </div>
            </div>
          `;
        }

        popupContent += `</div>`;

        // 6. أدوات التصدير
        popupContent += `
          <div class="export-panel">
            <div class="export-title">📤 أدوات التصدير العلمي</div>
            <div class="export-options">
              <button class="export-btn" onclick="exportData(${JSON.stringify(allData).replace(/"/g, '&quot;')}, 'json')">
                <i>📄</i> JSON
              </button>
              <button class="export-btn" onclick="exportData(${JSON.stringify(allData).replace(/"/g, '&quot;')}, 'csv')">
                <i>📊</i> CSV
              </button>
              <button class="export-btn" onclick="exportData(${JSON.stringify(allData).replace(/"/g, '&quot;')}, 'pdf')">
                <i>📑</i> PDF
              </button>
              <button class="export-btn" onclick="navigator.clipboard.writeText(JSON.stringify(${JSON.stringify(allData)}, null, 2)).then(() => alert('تم نسخ البيانات إلى الحافظة!'))">
                <i>📋</i> نسخ
              </button>
            </div>
          </div>
        `;

        popupContent += `
            </div>
            <div class="popup-footer">
              <div>تم التحليل في: ${new Date().toLocaleString('ar-SA')}</div>
              <div class="action-buttons">
                <button class="btn btn-outline" onclick="this.closest('.leaflet-popup').querySelector('.leaflet-popup-close-button').click()">إغلاق</button>
              </div>
            </div>
          </div>
        `;

        popup.setContent(popupContent);

        // بعد تحميل المحتوى، إنشاء المخططات
        setTimeout(() => {
          const landUseChart = document.getElementById('landUseChart');
          if (landUseChart && overpassData && overpassData.elements && overpassData.elements.length > 0) {
            const landUse = analyzeLandUse(overpassData.elements);
            createPieChart(landUseChart.getContext('2d'), 
              [landUse.urban, landUse.agricultural, landUse.natural, landUse.industrial, landUse.recreational],
              ['حضرية', 'زراعية', 'طبيعية', 'صناعية', 'ترفيهية'],
              'توزيع استخدامات الأراضي'
            );
          }
        }, 100);

      } catch (error) {
        console.error("Error:", error);
        popup.setContent(`
          <div class="popup-container">
            <div class="popup-header">
              <div class="popup-title">❌ خطأ في التحليل العلمي</div>
            </div>
            <div class="popup-body">
              <div class="error">
                تعذر إكمال التحليل العلمي لهذه النقطة.<br/>
                يرجى المحاولة بنقطة أخرى أو التحقق من اتصال الإنترنت.<br/>
                <small>الخطأ: ${error.message}</small>
              </div>
            </div>
            <div class="popup-footer">
              <div>التحليل في الوقت الحقيقي</div>
              <div class="action-buttons">
                <button class="btn btn-outline" onclick="this.closest('.leaflet-popup').querySelector('.leaflet-popup-close-button').click()">إغلاق</button>
              </div>
            </div>
          </div>
        `);
      }
    });

    // إضافة وظيفة إعادة التمركز
    document.querySelector('.header-icons').children[0].addEventListener('click', () => {
      map.setView([31.7917, -7.0926], 6);
    });

    // إضافة وظيفة التبديل للوضع العلمي
    document.querySelector('.header-icons').children[1].addEventListener('click', () => {
      scientificMode = !scientificMode;
      const icon = document.querySelector('.header-icons').children[1];
      const modeText = document.querySelector('.mode-toggle');
      
      if (scientificMode) {
        icon.innerHTML = '<i>🔬</i>';
        modeText.textContent = 'الوضع العلمي';
        document.querySelector('.info-text').textContent = 'الوضع العلمي مفعل - تحليل متقدم للبيانات المكانية باستخدام تقنيات الذكاء الاصطناعي';
      } else {
        icon.innerHTML = '<i>📊</i>';
        modeText.textContent = 'الوضع العادي';
        document.querySelector('.info-text').textContent = 'انقر على أي نقطة في الخريطة لتحليل البيانات الجغرافية المتقدمة باستخدام تقنيات الذكاء الاصطناعي';
      }
    });

    // إضافة وظيفة المشاركة
    document.querySelector('.header-icons').children[2].addEventListener('click', () => {
      const center = map.getCenter();
      const zoom = map.getZoom();
      const shareUrl = `${window.location.href.split('?')[0]}?lat=${center.lat.toFixed(6)}&lng=${center.lng.toFixed(6)}&zoom=${zoom}`;
      
      if (navigator.share) {
        navigator.share({
          title: 'منصة التحليل الجغرافي العلمية',
          text: 'انظر هذه النقطة المثيرة للاهتمام على الخريطة التفاعلية مع التحليل العلمي الكامل',
          url: shareUrl
        });
      } else {
        navigator.clipboard.writeText(shareUrl).then(() => {
          alert('تم نسخ رابط الموقع إلى الحافظة!');
        });
      }
    });

    // جعل دالة التصدير متاحة عالمياً
    window.exportData = exportData;
  </script>
</body>
</html>
