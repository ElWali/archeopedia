<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Archeopedia - ÿÆÿ±Ÿäÿ∑ÿ© ÿßŸÑŸÖŸàÿßŸÇÿπ ÿßŸÑÿ£ÿ´ÿ±Ÿäÿ© ÿßŸÑŸÖÿ∫ÿ±ÿ®Ÿäÿ©</title>
  <link href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css" rel="stylesheet">
  <style>
    body {
      margin: 0; padding: 0;
      font-family: 'Google Sans', 'Roboto', 'Arial', sans-serif;
      background: #e5e5e5;
      color: #222;
      height: 100vh;
      overflow: hidden;
    }
    #map {
      position: absolute;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      z-index: 1;
    }
    .search-bar {
      position: absolute;
      top: 24px; left: 50%; transform: translateX(-50%);
      width: 420px; max-width: 90vw;
      background: #fff;
      border-radius: 36px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.13);
      display: flex;
      align-items: center;
      padding: 8px 20px;
      z-index: 10;
    }
    .search-bar input {
      border: none;
      outline: none;
      font-size: 1.1em;
      flex: 1;
      background: transparent;
      padding: 9px 0;
    }
    .search-bar button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.2em;
      margin-right: 6px;
    }
    .autocomplete-suggestions {
      position: absolute;
      top: 60px; left: 50%; transform: translateX(-50%);
      width: 420px; max-width: 90vw;
      background: #fff;
      border-radius: 0 0 18px 18px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.11);
      z-index: 11;
      overflow: hidden;
    }
    .autocomplete-suggestions div {
      padding: 12px 18px;
      cursor: pointer;
      transition: background 0.18s;
      border-bottom: 1px solid #eee;
      font-size: 1.05em;
    }
    .autocomplete-suggestions div:last-child { border: none; }
    .autocomplete-suggestions div:hover, .autocomplete-suggestions div.active {
      background: #f1f3f4;
    }
    .sidebar {
      position: absolute;
      top: 96px; right: 24px;
      width: 320px; max-width: 95vw;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.11);
      z-index: 9;
      padding: 18px 18px 24px 18px;
      overflow-y: auto;
      max-height: 65vh;
      display: none;
      animation: fadeIn 0.2s;
    }
    .sidebar.open { display: block; }
    .sidebar h2 {
      margin: 0 0 8px 0;
      font-size: 1.2em;
      font-weight: bold;
    }
    .site-card {
      background: #fafafa;
      margin-bottom: 12px;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
      cursor: pointer;
      transition: box-shadow 0.14s;
    }
    .site-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.09);}
    .site-card strong { font-size: 1.08em; }
    .site-card .info { color: #555; font-size: 0.97em; margin-top: 3px;}
    .floating-card {
      position: absolute;
      bottom: 32px; left: 50%; transform: translateX(-50%);
      min-width: 300px; max-width: 90vw;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.13);
      z-index: 12;
      padding: 22px 22px 10px 22px;
      display: none;
      animation: fadeIn 0.2s;
    }
    .floating-card.open { display: block; }
    .floating-card h3 { margin: 0 0 8px 0; font-size: 1.15em; }
    .floating-card table { width: 100%; border-collapse: collapse; margin-top: 6px;}
    .floating-card th, .floating-card td { text-align: right; padding: 4px 6px; font-size: 0.97em; }
    .floating-card th { color: #888;}
    .floating-card .close-btn {
      position: absolute; top: 7px; right: 13px;
      background: none; border: none; font-size: 1.3em; color: #888; cursor: pointer;
    }
    .gm-controls {
      position: absolute;
      bottom: 24px; right: 24px;
      z-index: 15;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .gm-btn {
      background: #fff;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0,0,0,0.13);
      border: none;
      width: 48px; height: 48px;
      font-size: 1.3em;
      color: #333;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.18s;
    }
    .gm-btn:hover { background: #f1f3f4;}
    @media (max-width: 600px) {
      .sidebar { top: 80px; right: 5vw; width: 90vw; border-radius: 14px;}
      .search-bar, .autocomplete-suggestions { width: 98vw; max-width: 98vw;}
      .floating-card { min-width: 80vw; padding: 18px 9vw 10px 9vw;}
    }
    @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="search-bar">
    <button title="ÿßŸÑŸÇÿßÿ¶ŸÖÿ©" onclick="toggleSidebar()"><span>‚ò∞</span></button>
    <input type="text" id="searchBox" placeholder="ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖŸàŸÇÿπ ÿ£ÿ´ÿ±Ÿä..." autocomplete="off" />
    <button title="ÿ®ÿ≠ÿ´" onclick="triggerSearch()"><span>üîç</span></button>
  </div>
  <div id="searchSuggestions" class="autocomplete-suggestions"></div>
  <div id="sidebar" class="sidebar">
    <h2>ŸÉŸÑ ÿßŸÑŸÖŸàÿßŸÇÿπ</h2>
    <div id="siteList"></div>
  </div>
  <div id="floatingCard" class="floating-card">
    <button class="close-btn" onclick="closeCard()">‚úñ</button>
    <h3 id="cardTitle"></h3>
    <table id="cardTable"></table>
  </div>
  <div class="gm-controls">
    <button class="gm-btn" title="ÿ™ŸÉÿ®Ÿäÿ±" onclick="zoomIn()">Ôºã</button>
    <button class="gm-btn" title="ÿ™ÿµÿ∫Ÿäÿ±" onclick="zoomOut()">Ôºç</button>
    <button class="gm-btn" title="ŸÖŸàŸÇÿπŸä" onclick="locateMe()">üìç</button>
    <button class="gm-btn" title="ÿ•ÿπÿßÿØÿ© ÿ∂ÿ®ÿ∑" onclick="resetMap()">‚ü≥</button>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
  <script>
    // --- MAP INIT ---
    const map = L.map('map', { center: [31.5, -7], zoom: 6, zoomControl: false });
    const esriImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' }).addTo(map);

    let rawData = [], markers = [], suggestions = [];
    let activeCardSite = null;

    async function fetchData() {
      const res = await fetch('data/output.json');
      rawData = await res.json();
      suggestions = rawData.map(s => s.site.toLowerCase());
      populateSidebar(rawData);
      addMarkers(rawData);
    }

    function addMarkers(data) {
      markers.forEach(m => map.removeLayer(m));
      markers = [];
      data.forEach(site => {
        if (!site.lat || !site.lng) return;
        const marker = L.marker([+site.lat, +site.lng], {title:site.site});
        marker.on('click', () => showFloatingCard(site));
        marker.addTo(map);
        markers.push(marker);
      });
    }

    function populateSidebar(data) {
      const list = document.getElementById('siteList');
      list.innerHTML = '';
      data.forEach(site => {
        const div = document.createElement('div');
        div.className = 'site-card';
        div.innerHTML = `<strong>${site.site}</strong>
          <div class="info">${site.periods || ''} - ${site.region || ''}</div>`;
        div.onclick = () => {
          showFloatingCard(site);
          closeSidebar();
          map.setView([+site.lat, +site.lng], 12);
        };
        list.appendChild(div);
      });
    }

    // --- SEARCH AUTOCOMPLETE ---
    const searchBox = document.getElementById('searchBox');
    const suggestionsBox = document.getElementById('searchSuggestions');
    let selectedIndex = -1;
    searchBox.addEventListener('input', function() {
      const value = searchBox.value.toLowerCase();
      suggestionsBox.innerHTML = '';
      selectedIndex = -1;
      if (value.length < 2) {
        suggestionsBox.style.display = 'none';
        return;
      }
      const filtered = suggestions.filter(s => s.includes(value)).slice(0, 8);
      if (filtered.length === 0) {
        suggestionsBox.innerHTML = '<div>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿßŸÇÿ™ÿ±ÿßÿ≠ÿßÿ™.</div>';
        suggestionsBox.style.display = 'block';
        return;
      }
      suggestionsBox.style.display = 'block';
      filtered.forEach((s, i) => {
        const div = document.createElement('div');
        div.textContent = s;
        div.className = i === selectedIndex ? 'active' : '';
        div.onclick = () => {
          searchBox.value = s;
          suggestionsBox.innerHTML = '';
          suggestionsBox.style.display = 'none';
          triggerSearch();
        };
        div.onmouseenter = () => {
          selectedIndex = i;
          highlightSuggestions();
        };
        suggestionsBox.appendChild(div);
      });
    });
    searchBox.addEventListener('blur', () => {
      setTimeout(() => {
        suggestionsBox.innerHTML = '';
        suggestionsBox.style.display = 'none';
      }, 120);
    });
    searchBox.addEventListener('keydown', (e) => {
      const items = suggestionsBox.querySelectorAll('div');
      if (!items.length) return;
      if (e.key === 'ArrowDown') {
        selectedIndex = (selectedIndex + 1) % items.length;
        highlightSuggestions();
        e.preventDefault();
      } else if (e.key === 'ArrowUp') {
        selectedIndex = (selectedIndex - 1 + items.length) % items.length;
        highlightSuggestions();
        e.preventDefault();
      } else if (e.key === 'Enter') {
        if (selectedIndex >= 0) {
          searchBox.value = items[selectedIndex].textContent;
          suggestionsBox.innerHTML = '';
          suggestionsBox.style.display = 'none';
          triggerSearch();
          e.preventDefault();
        } else {
          triggerSearch();
        }
      } else if (e.key === 'Escape') {
        suggestionsBox.innerHTML = '';
        suggestionsBox.style.display = 'none';
      }
    });
    function highlightSuggestions() {
      const items = suggestionsBox.querySelectorAll('div');
      items.forEach((item, i) => {
        item.className = (i === selectedIndex) ? 'active' : '';
      });
    }
    function triggerSearch() {
      const term = searchBox.value.toLowerCase();
      const filtered = rawData.filter(s => s.site.toLowerCase().includes(term));
      populateSidebar(filtered);
      addMarkers(filtered);
      openSidebar();
    }

    // --- SIDEBAR CONTROL ---
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      if (sidebar.classList.contains('open')) closeSidebar();
      else openSidebar();
    }
    function openSidebar() {
      document.getElementById('sidebar').classList.add('open');
    }
    function closeSidebar() {
      document.getElementById('sidebar').classList.remove('open');
    }

    // --- FLOATING CARD ---
    function showFloatingCard(site) {
      activeCardSite = site;
      const card = document.getElementById('floatingCard');
      document.getElementById('cardTitle').textContent = site.site;
      const table = document.getElementById('cardTable');
      table.innerHTML = '';
      for (const key in site) {
        if (!site[key]) continue;
        const row = document.createElement('tr');
        row.innerHTML = `<th>${key}</th><td>${site[key]}</td>`;
        table.appendChild(row);
      }
      card.classList.add('open');
    }
    function closeCard() {
      document.getElementById('floatingCard').classList.remove('open');
    }
    // --- MAP CONTROLS ---
    function zoomIn() { map.setZoom(map.getZoom() + 1); }
    function zoomOut() { map.setZoom(map.getZoom() - 1); }
    function resetMap() {
      map.setView([31.5, -7], 6);
      addMarkers(rawData);
      closeCard();
    }
    function locateMe() {
      if (!navigator.geolocation) {
        alert('ŸÖÿ™ÿµŸÅÿ≠ŸÉ ŸÑÿß ŸäÿØÿπŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ.');
        return;
      }
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        map.setView([lat, lng], 14);
        L.marker([lat, lng]).addTo(map).bindPopup('ŸÖŸàŸÇÿπŸä ÿßŸÑÿ≠ÿßŸÑŸä').openPopup();
      }, () => {
        alert('ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ.');
      });
    }

    // --- INIT ---
    fetchData();
  </script>
</body>
</html>
